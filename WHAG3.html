<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>World History Review Arcade</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0b1020;
    --bg2:#070a14;
    --panel: rgba(255,255,255,.06);
    --panel2: rgba(255,255,255,.09);
    --border: rgba(255,255,255,.12);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.70);
    --muted2: rgba(255,255,255,.55);
    --accent: #7dd3fc;
    --accent2:#a78bfa;
    --good: #86efac;
    --warn: #fde68a;
    --bad: #fda4af;
    --shadow: 0 18px 60px rgba(0,0,0,.45);
    --radius: 18px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color: var(--text);
    background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.18), transparent 60%),
                radial-gradient(900px 700px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
                linear-gradient(180deg, var(--bg), var(--bg2));
    overflow-x: hidden;
  }
  /* subtle "network" overlay */
  body::before {
    content:"";
    position: fixed; inset: 0;
    pointer-events:none;
    background:
      radial-gradient(circle at 15% 30%, rgba(255,255,255,.06) 1px, transparent 1px) 0 0/44px 44px,
      radial-gradient(circle at 60% 70%, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/54px 54px,
      linear-gradient(transparent 0, rgba(255,255,255,.02) 100%);
    opacity: .55;
    mix-blend-mode: overlay;
  }
  a { color: var(--accent); text-decoration: none; }
  .app { max-width: 1100px; margin: 0 auto; padding: 18px 16px 42px; position: relative; }
  header {
    display:flex; align-items:center; justify-content:space-between;
    gap: 14px; padding: 14px 14px;
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
  }
  .brand {
    display:flex; align-items:center; gap: 12px;
  }
  .logo {
    width: 42px; height: 42px; border-radius: 14px;
    background: radial-gradient(circle at 30% 20%, rgba(125,211,252,.55), rgba(167,139,250,.35));
    border: 1px solid rgba(255,255,255,.18);
    display:grid; place-items:center;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .logo span { font-size: 20px; }
  .brand h1 {
    font-size: 16px; line-height: 1.1; margin: 0;
    letter-spacing: .2px;
  }
  .brand .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  nav {
    display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end;
  }
  .pill {
    appearance:none; border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    color: var(--text);
    padding: 9px 11px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 650;
    font-size: 12px;
    letter-spacing: .2px;
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
    user-select:none;
  }
  .pill:hover { background: rgba(255,255,255,.07); }
  .pill:active { transform: translateY(1px); }
  .pill.active {
    background: linear-gradient(90deg, rgba(125,211,252,.18), rgba(167,139,250,.14));
    border-color: rgba(125,211,252,.35);
  }
  .grid {
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 14px;
    margin-top: 14px;
  }
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
  }
  .section {
    padding: 14px;
  }
  .title {
    margin: 0 0 6px;
    font-size: 14px;
    letter-spacing: .2px;
  }
  .muted { color: var(--muted); font-size: 12px; line-height: 1.35; }
  .row { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
  .btn {
    appearance:none; border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor: pointer;
    font-weight: 700;
    letter-spacing:.15px;
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
  }
  .btn:hover { background: rgba(255,255,255,.08); }
  .btn:active { transform: translateY(1px); }
  .btn.primary {
    background: linear-gradient(90deg, rgba(125,211,252,.22), rgba(167,139,250,.18));
    border-color: rgba(125,211,252,.38);
  }
  .btn.good {
    background: rgba(134,239,172,.12);
    border-color: rgba(134,239,172,.35);
  }
  .btn.bad {
    background: rgba(253,164,175,.12);
    border-color: rgba(253,164,175,.35);
  }
  .btn.ghost {
    background: transparent;
  }
  .input {
    width: min(620px, 100%);
    padding: 11px 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline: none;
  }
  .input:focus { border-color: rgba(125,211,252,.48); box-shadow: 0 0 0 3px rgba(125,211,252,.12); }
  .select {
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline: none;
  }
  .kpi {
    display:flex; gap: 10px; flex-wrap: wrap;
    margin-top: 10px;
  }
  .kpi .chip {
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    border-radius: 999px;
    padding: 7px 10px;
    font-size: 12px;
    color: var(--muted);
  }
  .chip strong { color: var(--text); }
  .hidden { display:none !important; }
  .col-span-4 { grid-column: span 4; }
  .col-span-5 { grid-column: span 5; }
  .col-span-6 { grid-column: span 6; }
  .col-span-7 { grid-column: span 7; }
  .col-span-8 { grid-column: span 8; }
  .col-span-12 { grid-column: span 12; }
  @media (max-width: 980px) {
    .col-span-4,.col-span-5,.col-span-6,.col-span-7,.col-span-8 { grid-column: span 12; }
    nav { justify-content:flex-start; }
  }

  /* Game area */
  .gameTop {
    display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;
    padding: 12px 14px; border-bottom: 1px solid var(--border);
  }
  .badge {
    border: 1px solid var(--border);
    background: rgba(255,255,255,.04);
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    color: var(--muted);
  }
  .prompt {
    padding: 14px;
    font-size: 16px;
    line-height: 1.35;
    letter-spacing: .1px;
  }
  .prompt .blank {
    display:inline-block;
    padding: 0 6px 2px;
    border-bottom: 2px dashed rgba(125,211,252,.55);
    color: rgba(255,255,255,.95);
  }
  .gameBody { padding: 14px; }
  .choices {
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 10px; margin-top: 10px;
  }
  @media (max-width: 640px) {
    .choices { grid-template-columns: 1fr; }
  }
  .choice {
    text-align:left;
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.05);
        color: #fff;
cursor: pointer;
    font-weight: 650;
    letter-spacing:.15px;
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
  }
  .choice:hover { background: rgba(255,255,255,.08); }
  .choice:active { transform: translateY(1px); }
  .choice.correct { border-color: rgba(134,239,172,.50); background: rgba(134,239,172,.10); }
  .choice.wrong { border-color: rgba(253,164,175,.55); background: rgba(253,164,175,.10); }
  .toast {
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    min-width: min(720px, calc(100% - 20px));
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 12px 14px;
    display:flex; gap: 10px; align-items:flex-start; justify-content:space-between;
    box-shadow: 0 20px 70px rgba(0,0,0,.45);
    backdrop-filter: blur(12px);
  }
  .toast strong { display:block; margin-bottom: 2px; }
  .toast .msg { color: var(--muted); font-size: 12px; line-height: 1.35; }
  .toast.hidden { display:none; }
  .bar {
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.12);
    overflow:hidden;
  }
  .bar > i {
    display:block; height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(125,211,252,.65), rgba(167,139,250,.55));
  }
  .table {
    width:100%;
    border-collapse: collapse;
  }
  .table th, .table td {
    text-align:left;
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    font-size: 12px;
    color: var(--muted);
  }
  .table th { color: rgba(255,255,255,.80); font-weight: 800; }
  .right { text-align:right; }
  .modalBackdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
  }
  .modalBackdrop.show { display:flex; }
  .modal {
    width: min(900px, 100%);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modalHeader {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:space-between; gap: 10px;
  }
  .modalBody { padding: 14px; }
  textarea {
    width:100%;
    min-height: 220px;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline:none;
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.35;
  }
  .mini { font-size: 11px; color: var(--muted2); }
  .tag {
    font-size: 11px;
    padding: 5px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: rgba(255,255,255,.75);
  }
  .modeCard {
    padding: 14px;
    cursor:pointer;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: rgba(255,255,255,.05);
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
  }
  .modeCard:hover { background: rgba(255,255,255,.07); }
  .modeCard:active { transform: translateY(1px); }
  .modeCard h3 { margin: 0 0 6px; font-size: 14px; }
  .modeCard p { margin: 0; color: var(--muted); font-size: 12px; line-height: 1.35; }
  .modeGrid {
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  @media (max-width: 900px) { .modeGrid { grid-template-columns: 1fr; } }
  .gridTiles {
    display:grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
    padding: 14px;
  }
  @media (max-width: 700px) { .gridTiles { grid-template-columns: repeat(2, 1fr); } }
  .tile {
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    padding: 12px;
    cursor:pointer;
    min-height: 72px;
    display:flex; flex-direction:column; justify-content:space-between;
    transition: transform .08s ease, background .18s ease, border-color .18s ease;
  }
  .tile:hover { background: rgba(255,255,255,.06); }
  .tile:active { transform: translateY(1px); }
  .tile .tTitle { font-weight: 850; font-size: 12px; letter-spacing: .2px; }
  .tile .tMeta { color: var(--muted); font-size: 11px; }
  .tile.used { opacity: .45; cursor:not-allowed; }
  .sr-only {
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

/* ===== World History extras ===== */
.buzzGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
.buzzBtn{padding:14px 12px;border-radius:18px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-weight:950;cursor:pointer;transition:transform .06s ease}
.buzzBtn:active{transform:scale(.98)}
.buzzBtn.locked{opacity:.55;cursor:not-allowed}
.notice{padding:10px 12px;border-radius:14px;border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.05);margin-top:10px}
.timelineWrap{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
.timelineList{display:flex;flex-direction:column;gap:8px}
.tlCard{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06)}
.tlHandle{cursor:grab;user-select:none;font-size:18px;opacity:.85}
.tlTitle{flex:1;font-weight:900}
.tlMini{font-size:12px;opacity:.78}
.tlTools{display:flex;gap:8px}
.iconBtn{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:12px;padding:6px 8px;cursor:pointer}
.iconBtn:active{transform:scale(.98)}



  /* ===== Review Guide (auto-graded worksheet) ===== */
.reviewWrap{display:flex; flex-direction:column; gap:10px;}
.reviewQ{border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; background:rgba(255,255,255,.03);}
.reviewQTop{display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap; margin-bottom:8px;}
.reviewPrompt{line-height:1.7;}
.blank-inline{display:inline-block; width:170px; min-width:120px; margin:0 6px; padding:8px 10px; vertical-align:baseline;}
.reviewVerdict.badge.small{padding:4px 8px; border-radius:999px;}
.reviewVerdict.good{background:rgba(52,211,153,.18); border:1px solid rgba(52,211,153,.35);}
.reviewVerdict.bad{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35);}
.reviewQ.correct{outline:2px solid rgba(52,211,153,.25);}
.reviewQ.wrong{outline:2px solid rgba(239,68,68,.20);}
@media print{
  header, nav, .toast, #scoreStrip, #btnExit, #timerBadge, #view-settings, #view-progress, #view-modes, #view-home { display:none !important; }
  body{ background:white !important; color:#111 !important; }
  .card{ box-shadow:none !important; border:1px solid #ddd !important; }
  .reviewQ{ page-break-inside:avoid; background:white !important; border:1px solid #ddd !important; }
  .input{ border:1px solid #999 !important; background:white !important; color:#111 !important; }
}


/* ===== Arcade CRT Theme Additions (v6) ===== */
:root{
  --arcade-bg:#0f172a;
  --arcade-blue:#3b82f6;
  --arcade-pink:#ec4899;
  --arcade-green:#22c55e;
  --arcade-yellow:#facc15;
}
body{
  background-color: var(--arcade-bg);
  color: #fff;
  font-family: 'Rajdhani', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
/* Arcade fonts */
.font-arcade{ font-family: 'Press Start 2P', ui-monospace, monospace; letter-spacing: .04em; }
.font-tech{ font-family: 'Orbitron', ui-sans-serif, system-ui; letter-spacing: .05em; }

/* CRT Scanlines overlay */
#scanlines{
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  background: linear-gradient(
      to bottom,
      rgba(255,255,255,0),
      rgba(255,255,255,0) 50%,
      rgba(0,0,0,0.22) 50%,
      rgba(0,0,0,0.22)
    );
  background-size: 100% 4px;
  mix-blend-mode: overlay;
  opacity: .65;
}

/* Neon glow helpers */
.neon-text-blue{ text-shadow: 0 0 5px rgba(59,130,246,.9), 0 0 10px rgba(59,130,246,.55), 0 0 18px rgba(59,130,246,.35); }
.neon-text-pink{ text-shadow: 0 0 5px rgba(236,72,153,.9), 0 0 10px rgba(236,72,153,.55), 0 0 18px rgba(236,72,153,.35); }
.neon-box{
  box-shadow: 0 0 12px rgba(59,130,246,.35), inset 0 0 10px rgba(59,130,246,.18);
}

/* Overlay used by Jeopardy/Conquest/etc */
.gameOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.80);
  z-index: 9000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.gameOverlay.hidden{ display:none; }
.overlayCard{
  width: min(860px, 96vw);
  border: 1px solid rgba(59,130,246,.45);
  background: rgba(15,23,42,.96);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 0 35px rgba(59,130,246,.22);
}
.overlayTop{
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap: 12px;
  margin-bottom: 10px;
}
.overlayTop .title{
  font-weight: 900;
  letter-spacing:.03em;
}
.overlayClose{
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: #fff;
  padding: 8px 10px;
  border-radius: 999px;
  cursor:pointer;
}
.overlayClose:hover{ background: rgba(255,255,255,.10); }

/* Jeopardy board */
.jBoard{ display:grid; gap:10px; }
.jBoard.cols-5{ grid-template-columns: repeat(5, minmax(0,1fr)); }
.jBoard.cols-4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.jCat{ padding: 10px; text-align:center; border-radius: 12px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); }
.jTile{
  border-radius: 14px;
  border: 1px solid rgba(59,130,246,.35);
  background: rgba(2,6,23,.55);
  padding: 16px 10px;
  text-align:center;
  font-weight: 900;
  cursor:pointer;
}
.jTile:hover{ transform: translateY(-1px); box-shadow: 0 0 22px rgba(59,130,246,.22); }
.jTile.done{ opacity:.45; cursor: default; filter: grayscale(0.35); transform:none; box-shadow:none; }

/* Conquest grid */
.cGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.cCell{
  aspect-ratio: 1/1;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 20px;
  font-weight: 900;
}
.cCell.you{ background: rgba(59,130,246,.35); border-color: rgba(59,130,246,.65); box-shadow: 0 0 22px rgba(59,130,246,.18); }
.cCell.them{ background: rgba(239,68,68,.32); border-color: rgba(239,68,68,.60); box-shadow: 0 0 22px rgba(239,68,68,.12); }
.cCell:hover{ transform: translateY(-1px); }



/* ===== Cyber Arcade Theme Override (Mission Complete) ===== */
:root{
  --bg: #0f172a;
  --bg2: #0b1226;
  --panel: rgba(15,23,42,.70);
  --panel2: rgba(15,23,42,.86);
  --border: rgba(59,130,246,.28);
  --text: rgba(255,255,255,.92);
  --muted: rgba(203,213,225,.82);
  --muted2: rgba(148,163,184,.78);
  --accent: #3b82f6;
  --accent2:#a78bfa;
  --good: #22c55e;
  --warn: #facc15;
  --bad: #ef4444;
  --radius: 18px;
  --shadow: 0 22px 70px rgba(0,0,0,.55);
}

/* Base */
html, body { height: 100%; }
body{
  background-color: var(--bg);
  background-image:
    radial-gradient(1200px 800px at 20% 0%, rgba(59,130,246,.22), transparent 60%),
    radial-gradient(900px 700px at 90% 20%, rgba(236,72,153,.18), transparent 55%),
    linear-gradient(180deg, var(--bg), var(--bg2));
  color: #fff;
  font-family: 'Rajdhani', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  overflow-x: hidden;
}

/* Remove old "network" overlay intensity (keep subtle) */
body::before{ opacity: .22; }

/* Arcade fonts */
.font-arcade{ font-family:'Press Start 2P', ui-monospace, monospace; letter-spacing:.06em; }
.font-tech{ font-family:'Orbitron', ui-sans-serif, system-ui; letter-spacing:.08em; }

/* Stars */
#stars{
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  opacity: .60;
  overflow: hidden;
}
#stars .star{
  position: absolute;
  width: 2px; height: 2px;
  border-radius: 999px;
  background: rgba(255,255,255,.92);
  filter: drop-shadow(0 0 6px rgba(59,130,246,.25));
  animation: twinkle var(--tw, 4s) ease-in-out infinite;
  animation-delay: var(--d, 0s);
}
@keyframes twinkle{ 0%,100%{ opacity: .15; transform: translateY(0) scale(var(--s,1)); } 50%{ opacity: 1; transform: translateY(-8px) scale(var(--s,1)); } }

/* Scanlines already present (#scanlines) - ensure it sits above everything */
#scanlines{ z-index: 9999; opacity: .70; }

/* App stacking */
.app{ position: relative; z-index: 1; max-width: 1200px; }

/* Header + cards as neon glass */
header, .card{
  background: rgba(15,23,42,.70);
  border: 1px solid rgba(59,130,246,.28);
  box-shadow: 0 0 18px rgba(59,130,246,.12), var(--shadow);
  backdrop-filter: blur(12px);
}
header{ padding: 16px 16px; }

/* Brand title */
.brand h1{
  font-family:'Press Start 2P', ui-monospace, monospace;
  letter-spacing:.08em;
  text-transform: uppercase;
  font-size: 14px;
  line-height: 1.2;
  color: #93c5fd;
  text-shadow: 0 0 6px rgba(59,130,246,.65), 0 0 16px rgba(59,130,246,.25);
}
.brand .sub{
  font-family:'Orbitron', ui-sans-serif, system-ui;
  letter-spacing:.22em;
  text-transform: uppercase;
  font-size: 11px;
  color: rgba(226,232,240,.72);
  margin-top: 6px;
}
.logo{
  border-radius: 16px;
  border: 1px solid rgba(59,130,246,.30);
  background: radial-gradient(circle at 30% 20%, rgba(59,130,246,.55), rgba(167,139,250,.25));
  box-shadow: 0 0 20px rgba(59,130,246,.18);
}

/* Nav pills */
.pill{
  font-family:'Orbitron', ui-sans-serif, system-ui;
  text-transform: uppercase;
  letter-spacing:.14em;
  font-size: 11px;
  padding: 10px 12px;
  border-color: rgba(255,255,255,.16);
  background: rgba(2,6,23,.40);
}
.pill.active{
  border-color: rgba(59,130,246,.55);
  background: linear-gradient(90deg, rgba(59,130,246,.22), rgba(236,72,153,.16));
  box-shadow: 0 0 18px rgba(59,130,246,.12);
}

/* Section titles */
.title{
  font-family:'Press Start 2P', ui-monospace, monospace;
  letter-spacing:.06em;
  text-transform: uppercase;
  font-size: 12px;
  color: #facc15;
  text-shadow: 0 0 8px rgba(250,204,21,.18);
}
.muted{ color: rgba(226,232,240,.72); }
.tag, .badge, .chip{
  font-family:'Orbitron', ui-sans-serif, system-ui;
  letter-spacing:.10em;
  text-transform: uppercase;
}

/* Buttons */
.btn{
  font-family:'Orbitron', ui-sans-serif, system-ui;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-size: 12px;
  border-color: rgba(255,255,255,.16);
  background: rgba(2,6,23,.40);
}
.btn.primary{
  border-color: rgba(59,130,246,.55);
  background: linear-gradient(90deg, rgba(59,130,246,.30), rgba(236,72,153,.18));
  box-shadow: 0 0 20px rgba(59,130,246,.12);
}
.btn.good{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.14); }
.btn.bad{ border-color: rgba(239,68,68,.60); background: rgba(239,68,68,.14); }
.btn:hover, .pill:hover{ background: rgba(255,255,255,.08); }

/* Inputs */
.input, .select, textarea{
  border-color: rgba(255,255,255,.16);
  background: rgba(2,6,23,.45);
  color: #fff;
}
.input:focus, .select:focus, textarea:focus{
  border-color: rgba(59,130,246,.65);
  box-shadow: 0 0 0 3px rgba(59,130,246,.16);
}

/* Game prompt */
.prompt{
  font-family:'Rajdhani', ui-sans-serif, system-ui;
  font-size: 18px;
}
.choice{
  font-family:'Orbitron', ui-sans-serif, system-ui;
  letter-spacing:.06em;
  background: rgba(15,23,42,.65);
  border-color: rgba(59,130,246,.25);
}
.choice:hover{ box-shadow: 0 0 18px rgba(59,130,246,.12); }

/* Mode cards (Arcade lobby cards) */
.modeCard{
  position: relative;
  overflow: hidden;
  background: rgba(2,6,23,.45);
  border: 1px solid rgba(255,255,255,.14);
}
.modeCard::before{
  content:"";
  position:absolute;
  inset: -2px;
  background: linear-gradient(90deg, rgba(59,130,246,.60), rgba(167,139,250,.55));
  opacity: .22;
  filter: blur(14px);
  z-index: 0;
}
.modeCard > *{ position: relative; z-index: 1; }
.modeCard h3{
  font-family:'Press Start 2P', ui-monospace, monospace;
  font-size: 12px;
  color: #93c5fd;
  text-shadow: 0 0 10px rgba(59,130,246,.22);
}
.modeCard p{ font-family:'Orbitron', ui-sans-serif, system-ui; font-size: 11px; letter-spacing:.08em; }
.modeCard:hover{ border-color: rgba(59,130,246,.45); box-shadow: 0 0 22px rgba(59,130,246,.14); }

/* Color variants */
.modeCard[data-color="cyan"]::before{ background: linear-gradient(90deg, rgba(34,211,238,.70), rgba(59,130,246,.55)); }
.modeCard[data-color="purple"]::before{ background: linear-gradient(90deg, rgba(167,139,250,.70), rgba(236,72,153,.55)); }
.modeCard[data-color="emerald"]::before{ background: linear-gradient(90deg, rgba(16,185,129,.70), rgba(34,197,94,.55)); }
.modeCard[data-color="red"]::before{ background: linear-gradient(90deg, rgba(239,68,68,.70), rgba(249,115,22,.55)); }
.modeCard[data-color="yellow"]::before{ background: linear-gradient(90deg, rgba(250,204,21,.70), rgba(249,115,22,.55)); }
.modeCard[data-color="pink"]::before{ background: linear-gradient(90deg, rgba(236,72,153,.70), rgba(59,130,246,.45)); }
.modeCard[data-color="orange"]::before{ background: linear-gradient(90deg, rgba(249,115,22,.70), rgba(250,204,21,.55)); }

/* Scrollbar (Chrome/Edge) */
.custom-scroll::-webkit-scrollbar { width: 8px; }
.custom-scroll::-webkit-scrollbar-track { background: rgba(15,23,42,.75); }
.custom-scroll::-webkit-scrollbar-thumb { background: rgba(59,130,246,.65); border-radius: 999px; }

/* Make main content scrollable when needed */
.app{ padding-bottom: 60px; }



/* Home marquee */
.arcadeHero{ text-align:center; padding: 22px 16px; }
.arcadeHeroInner{ max-width: 980px; margin: 0 auto; }
.arcadeHeroTitle{ font-size: 34px; line-height: 1.15; color: #e0f2fe; }
.arcadeHeroSub{ margin-top: 10px; font-size: 12px; letter-spacing: .35em; color: rgba(148,163,184,.85); }
.arcadeHeroHint{ margin-top: 12px; font-size: 14px; color: rgba(226,232,240,.72); }
@media (max-width: 520px){
  .arcadeHeroTitle{ font-size: 26px; }
}



/* Scrollbar (Chrome/Edge) */
body::-webkit-scrollbar { width: 8px; }
body::-webkit-scrollbar-track { background: rgba(15,23,42,.75); }
body::-webkit-scrollbar-thumb { background: rgba(59,130,246,.65); border-radius: 999px; }
/* ===== FIX: force white text in Memory Flip + Jeopardy Grid ===== */

/* Memory Flip renders buttons with class="card ..." inside #gameControls */
#gameControls button.card,
#gameControls button.card * {
  color: #fff !important;
}

/* Jeopardy Grid tiles + category headers */
#gameControls .jTile,
#gameControls .jTile:disabled,
#gameControls .jCat {
  color: #fff !important;
}
/* ===== Boss Battle FX (health bars + arena + attacks + shake + damage numbers) ===== */

/* Boss Battle HP bars use <div> fills, but base CSS styles <i>. Support both. */
.bar > div{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(125,211,252,.65), rgba(167,139,250,.55));
  transition: width .35s ease;
}

/* Boss Arena strip */
.bossStrip{
  margin-top: 10px;
  display: grid;
  grid-template-columns: 1fr minmax(160px, 260px) 1fr;
  gap: 10px;
  align-items: center;
  padding: 10px;
  border-radius: 16px;
  border: 1px solid rgba(59,130,246,.28);
  background: rgba(2,6,23,.35);
  box-shadow: 0 0 18px rgba(59,130,246,.12);
}
@media (max-width: 640px){
  .bossStrip{ grid-template-columns: 1fr; }
}
.bossMeta .mini{ margin-bottom: 6px; }
.bossMeta.right{ text-align:right; }

.bossStage{
  position: relative;
  height: 72px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(120px 80px at 50% 50%, rgba(59,130,246,.10), transparent 70%),
    rgba(255,255,255,.04);
  overflow: hidden;
}

.fighter{
  position: absolute;
  bottom: 8px;
  width: 54px;
  height: 54px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(15,23,42,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 28px;
  box-shadow: 0 0 16px rgba(59,130,246,.14);
  will-change: transform, filter;
  z-index: 2;
}
.fighter.hero{ left: 10px; }
.fighter.boss{ right: 10px; }

.fighter.hit{ animation: bossHit .32s ease-out; }
@keyframes bossHit{
  0%{ filter: brightness(1.2); transform: translateX(0) scale(1); }
  40%{ filter: brightness(2); transform: translateX(-6px) scale(.98); }
  100%{ filter: brightness(1); transform: translateX(0) scale(1); }
}

.fighter.hero.atk{ animation: heroAtk .34s cubic-bezier(.2,.9,.2,1); }
.fighter.boss.atk{ animation: bossAtk .34s cubic-bezier(.2,.9,.2,1); }
@keyframes heroAtk{
  0%{ transform: translateX(0) scale(1); }
  55%{ transform: translateX(86px) scale(1.04); }
  100%{ transform: translateX(0) scale(1); }
}
@keyframes bossAtk{
  0%{ transform: translateX(0) scale(1); }
  55%{ transform: translateX(-86px) scale(1.04); }
  100%{ transform: translateX(0) scale(1); }
}

/* Flash overlay */
.bossFlash{
  position:absolute;
  inset:0;
  opacity:0;
  pointer-events:none;
  z-index: 1;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%);
}
.bossStage.flash-good .bossFlash{ animation: flashGood .28s ease-out; }
.bossStage.flash-bad  .bossFlash{ animation: flashBad  .28s ease-out; }
@keyframes flashGood{
  0%{ opacity:0; }
  30%{ opacity:.45; }
  100%{ opacity:0; }
}
@keyframes flashBad{
  0%{ opacity:0; }
  30%{ opacity:.65; background: radial-gradient(circle at 50% 50%, rgba(248,113,113,.70), rgba(248,113,113,0) 60%); }
  100%{ opacity:0; }
}

/* Screen shake (apply to #view-game .card) */
.bossShake{
  --shake: 10px;
  animation: bossShake .36s ease-in-out;
}
@keyframes bossShake{
  0%{ transform: translate(0,0); }
  15%{ transform: translate(calc(var(--shake)*-1), calc(var(--shake)*.5)); }
  30%{ transform: translate(calc(var(--shake)*.8), calc(var(--shake)*-.4)); }
  45%{ transform: translate(calc(var(--shake)*-.6), calc(var(--shake)*.3)); }
  60%{ transform: translate(calc(var(--shake)*.4), calc(var(--shake)*-.2)); }
  100%{ transform: translate(0,0); }
}

/* Floating damage numbers */
.floatDmg{
  position:absolute;
  font-weight: 900;
  letter-spacing: .04em;
  text-shadow: 0 0 12px rgba(0,0,0,.55);
  user-select:none;
  pointer-events:none;
  opacity: 0;
  animation: floatDmg 850ms ease-out forwards;
}
.floatDmg.good{ color: rgba(134,239,172,.95); }
.floatDmg.bad{  color: rgba(248,113,113,.95); }
.floatDmg.nomotion{ opacity: 1; } /* used when Reduce Motion is ON */

@keyframes floatDmg{
  0%{ opacity: 0; transform: translate(-50%, 6px) scale(.98); }
  18%{ opacity: 1; transform: translate(-50%, 0) scale(1.02); }
  100%{ opacity: 0; transform: translate(-50%, -26px) scale(1.05); }
}

@media (prefers-reduced-motion: reduce){
  .fighter.hero.atk, .fighter.boss.atk, .fighter.hit,
  .bossStage.flash-good .bossFlash, .bossStage.flash-bad .bossFlash,
  .bossShake, .floatDmg{
    animation: none !important;
  }
  .floatDmg{ opacity: 1 !important; }
  .bar > div{ transition: none !important; }
}

</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"><span>üåç</span></div>
      <div>
        <h1>World History Review Arcade</h1>
        <div class="sub">Multi‚Äëgame hub for world history review ‚Ä¢ offline‚Äëfriendly ‚Ä¢ projector‚Äëfriendly ‚Ä¢ no logins</div>
      </div>
    </div>
    <nav>
      <button class="pill active" data-nav="home">Home</button>
      <button class="pill" data-nav="modes">Modes</button>
      <button class="pill" data-nav="progress">Progress</button>
      <button class="pill" data-nav="settings">Settings</button>
    </nav>
  </header>

  <div id="view-home" class="grid">

    <div class="card section col-span-12 arcadeHero">
      <div class="arcadeHeroInner">
        <div class="arcadeHeroTitle neon-text-blue font-arcade">WORLD HISTORY<br/>ARCADE</div>
        <div class="arcadeHeroSub font-tech">FINAL EXAM PROTOCOL</div>
        <div class="arcadeHeroHint">Pick units, then choose a mode. Your progress is saved on this device.</div>
      </div>
    </div>

    <div class="card section col-span-7">
      <h2 class="title">Quick start</h2>
      <p class="muted">Pick your units, then jump into a mode. Everything is auto‚Äëgraded on this device.</p>

      <div class="row" style="margin-top:10px;">
        <label class="tag">Deck</label>
        <select id="deckSelect" class="select" aria-label="Deck">
          <option value="core">World History Review Guide (Auto‚Äëgraded)</option>
        </select>

        <label class="tag">Play</label>
        <select id="playSelect" class="select" aria-label="Play style">
          <option value="solo">Solo</option>
          <option value="teams">Teams (pass-and-play)</option>
        </select>

        <button class="btn" id="btnTeams" title="Edit teams">Edit teams</button>
      </div>

      <div class="row" style="margin-top:10px; align-items:flex-end;">
        <div class="col" style="flex:1;">
          <div class="mini" style="margin-bottom:6px;">Search</div>
          <input id="searchInput" class="input" placeholder="Type to filter questions‚Ä¶" />
          <div class="mini muted" style="margin-top:6px;">Units + Search filters apply to every mode.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <label class="tag">Units</label>
        <button class="pill active" data-unit="unit2">Unit 2</button>
        <button class="pill active" data-unit="unit3">Unit 3</button>
        <button class="pill active" data-unit="unit4">Unit 4</button>
        <button class="pill active" data-unit="unit5">Unit 5</button>
        <button class="pill active" data-unit="unit6">Unit 6</button>
        <button class="pill active" data-unit="unit7">Unit 7</button>
        <button class="pill active" data-unit="unit8">Unit 8</button>
        <button class="pill active" data-unit="unit9">Unit 9</button>
      </div>

      <div class="row" style="margin-top:10px; align-items:flex-end;">
        <div class="col" style="flex:1;">
          <div class="mini" style="margin-bottom:6px;">Search</div>
          <input id="searchInput" class="input" placeholder="Type to filter questions‚Ä¶" />
          <div class="mini muted" style="margin-top:6px;">Units + Search filters apply to every mode.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" data-start="quick">‚ñ∂ Quick Quiz</button>
        <button class="btn" data-start="lightning">‚ö° Lightning</button>
        <button class="btn" data-start="streak">üî• Streak Sprint</button>
        <button class="btn" data-start="flashcards">üÉè Flashcards</button>
        <button class="btn" data-start="match">üß© Match‚ÄëUp</button>
        <button class="btn" data-start="review">üìù Auto‚Äëgraded Review Guide</button>
      </div>

      <div class="kpi" id="homeKpis"></div>
    </div>

    <div class="card section col-span-5">
      <h2 class="title">What‚Äôs new in this rebuild</h2>
      <ul class="muted" style="margin:10px 0 0 18px;">
        <li><strong>Auto-checking</strong> for Core questions (PDF answer key)</li>
        <li><strong>No buzzer beeps</strong> ‚Äî sound is off by default</li>
        <li><strong>Multiple modes</strong> from the same deck (competitive + review)</li>
        <li><strong>Progress + mistake bank</strong> saved on-device</li>
        <li><strong>World History theme</strong> (map/timeline vibe)</li>
      </ul>

      <div class="row" style="margin-top:12px;">
        <button class="btn" data-start="mystery">üü¶ Mystery Grid</button>
        <button class="btn" data-start="showdown">üèÅ Team Showdown</button>
      </div>

      
    </div>
  </div>

  <div id="view-modes" class="grid hidden">
    <div class="card section col-span-12">
      <h2 class="title">Modes</h2>
      <div class="modeGrid" id="modeGrid"></div>
    </div>
  </div>

  <div id="view-progress" class="grid hidden">
    <div class="card section col-span-7">
      <h2 class="title">Mastery</h2>
      <p class="muted">Tracks correctness per question (on this device). Use ‚ÄúReview misses‚Äù to target weak spots.</p>
      <div id="masteryBars" style="margin-top:12px;"></div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnReviewMisses">üéØ Review misses</button>
        <button class="btn" id="btnResetProgress">Reset progress</button>
      </div>
    </div>

    <div class="card section col-span-5">
      <h2 class="title">Stats</h2>
      <table class="table" id="statsTable"></table>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnExport">Export</button>
        <button class="btn" id="btnImport">Import</button>
      </div>
      <p class="mini" style="margin-top:10px;">Export/Import lets you move progress between devices (copy/paste).</p>
    </div>
  </div>

  <div id="view-settings" class="grid hidden">
    <div class="card section col-span-7">
      <h2 class="title">Settings</h2>

      <div class="row" style="margin-top:10px;">
        <label class="tag">Timer</label>
        <select id="timerMode" class="select">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
        <label class="tag">Seconds</label>
        <input id="timerSeconds" class="input" type="number" min="10" max="120" step="5" style="max-width:140px;" />
      </div>

      <div class="row" style="margin-top:10px;">
        <label class="tag">Sound</label>
        <select id="soundMode" class="select">
          <option value="off">Off</option>
          <option value="on">On (subtle)</option>
        </select>

        <label class="tag">Reduce motion</label>
        <select id="motionMode" class="select">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>

        <label class="tag">Show hints</label>
        <select id="hintMode" class="select">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px; align-items:flex-end;">
        <div class="col" style="flex:1;">
          <div class="mini" style="margin-bottom:6px;">Search</div>
          <input id="searchInput" class="input" placeholder="Type to filter questions‚Ä¶" />
          <div class="mini muted" style="margin-top:6px;">Units + Search filters apply to every mode.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnSaveSettings">Save settings</button>
      </div>

      <!-- Question editor removed (all questions are built-in and auto-graded) -->
</div>

    <div class="card section col-span-5">
      <h2 class="title">About</h2>
      <p class="muted">This file is a complete, launch-ready HTML app. You can host it on any static site (Google Sites embed, GitHub Pages, Netlify, etc.) or just open it locally.</p>
      <div class="kpi" id="aboutKpis"></div>
    </div>
  </div>

  <div id="view-game" class="grid hidden">
    <div class="card col-span-12">
      <div class="gameTop">
        <div class="row">
          <span class="badge" id="gameModeBadge">Mode</span>
          <span class="badge" id="gameDeckBadge">Deck</span>
          <span class="badge" id="gameUnitBadge">Units</span>
        </div>
        <div class="row">
          <span class="badge" id="timerBadge">‚è± 0</span>
          <button class="btn ghost" id="btnExit">Exit</button>
        </div>
      </div>

      <div class="prompt" id="prompt"></div>

      <div class="gameBody">
        <div id="gameControls"></div>
        <div id="afterControls" class="hidden" style="margin-top:12px;"></div>

        <div id="scoreStrip" class="row" style="margin-top:14px; justify-content:space-between;">
          <div class="row" id="scoreLeft"></div>
          <div class="row" id="scoreRight"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast hidden" id="toast" role="status" aria-live="polite">
    <div>
      <strong id="toastTitle">Saved</strong>
      <div class="msg" id="toastMsg"></div>
    </div>
    <button class="btn ghost" id="toastClose">Close</button>
  </div>

  <div class="modalBackdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Modal">
      <div class="modalHeader">
        <div style="font-weight:900" id="modalTitle">Modal</div>
        <button class="btn ghost" id="modalClose">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>
</div>

<script>
/** =======================
 * World History Review Arcade
 * Single-file, offline-first
 * ======================= */

const DEFAULT_DECKS = {"core": [{"id": "wh-1", "num": 1, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The earliest civilizations developed in areas known as ______ ______, where rivers provided water, fertile soil, and transportation.", "acceptedAnswers": [["River"], ["Valleys"]], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-2", "num": 2, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The region between the Tigris and Euphrates Rivers is known as ______.", "acceptedAnswers": ["Mesopotamia"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-3", "num": 3, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The wedge-shaped writing system developed by the Sumerians is called ______.", "acceptedAnswers": ["Cuneiform"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-4", "num": 4, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The Babylonian king famous for a harsh law code based on ‚Äúan eye for an eye‚Äù was ______.", "acceptedAnswers": ["Hammurabi"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-5", "num": 5, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The Egyptian writing system that used pictures and symbols is called ______.", "acceptedAnswers": ["Hieroglyphics"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-6", "num": 6, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "Egyptians wrote on a type of paper made from reeds called ______.", "acceptedAnswers": ["Papyrus"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-7", "num": 7, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The process by which rulers in China claimed the right to rule from the gods is called the Mandate of ______.", "acceptedAnswers": ["Heaven"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-8", "num": 8, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "Respect for parents and ancestors, a key idea in Confucianism, is known as ______ ______.", "acceptedAnswers": [["Filial"], ["Piety"]], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-9", "num": 9, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "In the Indian caste system, a person‚Äôs social class was determined largely by ______ at birth.", "acceptedAnswers": ["Caste", "Birth"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-10", "num": 10, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The seasonal winds that affect agriculture in India were called ______.", "acceptedAnswers": ["Monsoons"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-11", "num": 11, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The belief in many gods is called ______, while the belief in one god is called ______.", "acceptedAnswers": [["Polytheism"], ["Monotheism"]], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-12", "num": 12, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The ancient Hebrews developed the monotheistic religion of ______.", "acceptedAnswers": ["Judaism"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-13", "num": 13, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The trade route that connected China to the Mediterranean world was called the ______ ______.", "acceptedAnswers": [["Silk"], ["Road"]], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-14", "num": 14, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The Bantu migrations spread knowledge of ______ working and ______ agriculture throughout sub-Saharan Africa.", "acceptedAnswers": [["Iron"], ["Slash-and-burn", "settled"]], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-15", "num": 15, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The early Mesoamerican civilization known for building colossal stone heads was the ______.", "acceptedAnswers": ["Olmec"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-16", "num": 16, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "The Chinese philosophy that stresses strict laws and harsh punishments is called ______.", "acceptedAnswers": ["Legalism"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-17", "num": 17, "unit": "unit2", "unitName": "Unit 2 ‚Ä¢ Ancient Civilizations", "type": "fill-blank", "prompt": "Fine yellow soil deposited by wind and rivers in northern China is called ______.", "acceptedAnswers": ["Loess"], "difficulty": 2, "points": 10, "hint": "U2"}, {"id": "wh-18", "num": 18, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "A Greek city-state, which was the basic political unit of ancient Greece, was called a ______.", "acceptedAnswers": ["Polis"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-19", "num": 19, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The Greek city-state known for democracy and cultural achievements was ______, while the one known for a militaristic society was ______.", "acceptedAnswers": [["Athens"], ["Sparta"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-20", "num": 20, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "Government in which citizens vote directly on laws is called direct ______.", "acceptedAnswers": ["Democracy"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-21", "num": 21, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The most famous Greek philosophers included Socrates, ______, and ______.", "acceptedAnswers": [["Plato"], ["Aristotle"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-22", "num": 22, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "After conquering a vast empire that spread Greek culture, ______ the Great helped create the Hellenistic world.", "acceptedAnswers": ["Alexander"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-23", "num": 23, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The Roman Republic was originally governed by a Senate made up mainly of wealthy landowners called ______.", "acceptedAnswers": ["Patricians"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-24", "num": 24, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "Written Roman laws that protected citizens‚Äô rights were called the ______ ______.", "acceptedAnswers": [["Twelve"], ["Tables"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-25", "num": 25, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The long period of peace and prosperity in the Roman Empire beginning with Augustus is known as the ______ ______.", "acceptedAnswers": [["Pax"], ["Romana"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-26", "num": 26, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The spread of ______ throughout the Roman Empire was helped by Rome‚Äôs roads, cities, and trade networks.", "acceptedAnswers": ["Christianity"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-27", "num": 27, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The fall of the ______ Roman Empire in 476 CE is often used as a marker for the end of ancient history in Western Europe.", "acceptedAnswers": ["Western"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-28", "num": 28, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The ______ Empire preserved Roman and Greek learning and had its capital at Constantinople.", "acceptedAnswers": ["Byzantine"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-29", "num": 29, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The Byzantine emperor who ordered the compilation of Roman laws into a single code was ______, and his powerful wife was Empress ______.", "acceptedAnswers": [["Justinian"], ["Theodora"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-30", "num": 30, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The Christian church split in 1054 in an event known as the ______ ______.", "acceptedAnswers": [["Great"], ["Schism"]], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-31", "num": 31, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The city that served as a vital trade link between Europe and Asia and later became Istanbul was ______.", "acceptedAnswers": ["Constantinople"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-32", "num": 32, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The nomadic horsemen who created the largest land empire in history under Chinggis (Genghis) Khan were the ______.", "acceptedAnswers": ["Mongols"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-33", "num": 33, "unit": "unit3", "unitName": "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires", "type": "fill-blank", "prompt": "The empire ruled from ______ (city) in the eastern Mediterranean is considered the continuation of the Roman Empire in the East.", "acceptedAnswers": ["Constantinople"], "difficulty": 2, "points": 10, "hint": "U3"}, {"id": "wh-34", "num": 34, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The religion founded by the prophet ______ in the Arabian Peninsula is called Islam.", "acceptedAnswers": ["Muhammad"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-35", "num": 35, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The holy book of Islam, believed to contain the word of God as revealed to Muhammad, is the ______.", "acceptedAnswers": ["Quran", "Koran"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-36", "num": 36, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The five basic religious duties every Muslim is expected to carry out are called the Five ______ of Islam.", "acceptedAnswers": ["Pillars"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-37", "num": 37, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The leader of the Muslim community after Muhammad‚Äôs death was called a ______.", "acceptedAnswers": ["Caliph"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-38", "num": 38, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The two main branches of Islam that split over disagreements about leadership are ______ and ______.", "acceptedAnswers": [["Sunni"], ["Shia"]], "difficulty": 2, "points": 10, "hint": "U4", "unordered": true}, {"id": "wh-39", "num": 39, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "Islam is part of the family of ______ religions (along with Judaism and Christianity).", "acceptedAnswers": ["Abrahamic"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-40", "num": 40, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The Islamic empire that moved its capital to Baghdad and presided over a golden age of science and learning was the ______ Caliphate.", "acceptedAnswers": ["Abbasid"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-41", "num": 41, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "A center of learning in Baghdad where scholars translated and preserved Greek and other texts was the House of ______.", "acceptedAnswers": ["Wisdom"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-42", "num": 42, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The great West African trading kingdoms that grew wealthy from the gold-salt trade included Ghana, ______, and ______.", "acceptedAnswers": [["Mali"], ["Songhai"]], "difficulty": 2, "points": 10, "hint": "U4", "unordered": true}, {"id": "wh-43", "num": 43, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The Muslim ruler of Mali who made a famous pilgrimage to Mecca and distributed gold along the way was ______ ______.", "acceptedAnswers": [["Mansa"], ["Musa"]], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-44", "num": 44, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "Trade across the Sahara Desert was carried out on ______ trade routes.", "acceptedAnswers": ["Trans-Saharan"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-45", "num": 45, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "A blended language and culture that developed on the East African coast through trade was ______ culture.", "acceptedAnswers": ["Swahili"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-46", "num": 46, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The traveler who recorded his journeys across the Islamic world, including Africa and Asia, was Ibn ______.", "acceptedAnswers": ["Battuta"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-47", "num": 47, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "The spread of Islam into Africa and Asia is an example of religious ______.", "acceptedAnswers": ["Diffusion"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-48", "num": 48, "unit": "unit4", "unitName": "Unit 4 ‚Ä¢ Islamic & African Civilizations", "type": "fill-blank", "prompt": "European attempts to control foreign regions, often through military ______, fueled tension and conflict.", "acceptedAnswers": ["Invasions", "Intervention"], "difficulty": 2, "points": 10, "hint": "U4"}, {"id": "wh-49", "num": 49, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The political and social system in medieval Europe based on land ownership, loyalty, and military service was called ______.", "acceptedAnswers": ["Feudalism"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-50", "num": 50, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The economic system of large estates where peasants farmed land for a lord in exchange for protection was the ______ system.", "acceptedAnswers": ["Manorial"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-51", "num": 51, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "Peasants who were legally bound to the land and owed service to their lord were called ______.", "acceptedAnswers": ["Serfs"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-52", "num": 52, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "Mounted warriors who followed a code of conduct known as chivalry were called ______.", "acceptedAnswers": ["Knights"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-53", "num": 53, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "During the Middle Ages, the Christian ______ played a central role in people‚Äôs lives, providing spiritual guidance and social services.", "acceptedAnswers": ["Church"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-54", "num": 54, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "A series of religious wars between Christians and Muslims for control of the Holy Land were called the ______.", "acceptedAnswers": ["Crusades"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-55", "num": 55, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The deadly epidemic that killed millions in Europe during the 14th century was the ______ ______.", "acceptedAnswers": [["Black", "Bubonic"], ["Death", "Plague"]], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-56", "num": 56, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "In 1215, English nobles forced King John to sign the ______ ______, which limited the power of the king.", "acceptedAnswers": [["Magna"], ["Carta"]], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-57", "num": 57, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The ‚Äúrebirth‚Äù of art and learning that began in Italian city-states like Florence in the 1300s is called the ______.", "acceptedAnswers": ["Renaissance"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-58", "num": 58, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "A movement that focused on human potential, worldly subjects, and classical learning is called ______.", "acceptedAnswers": ["Humanism"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-59", "num": 59, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The city of ______ became a center of Renaissance banking, trade, and art, supported by the Medici family.", "acceptedAnswers": ["Florence"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-60", "num": 60, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The German printer who invented a movable-type press that helped spread ideas quickly was Johannes ______.", "acceptedAnswers": ["Gutenberg"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-61", "num": 61, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The German monk who wrote the 95 Theses criticizing indulgences and began the Protestant Reformation was Martin ______.", "acceptedAnswers": ["Luther"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-62", "num": 62, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The term for payments made to the Church to reduce punishment for sins is ______.", "acceptedAnswers": ["Indulgences"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-63", "num": 63, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The branch of Christianity founded in England when Henry VIII broke with the Catholic Church is called the ______ Church.", "acceptedAnswers": ["Anglican"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-64", "num": 64, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The Catholic response to the Protestant Reformation, including the Council of Trent and the Jesuits, is called the ______ or Catholic Reformation.", "acceptedAnswers": ["Counter"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-65", "num": 65, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "In Japan, the military government headed by a shogun that controlled the country from the 1600s to the 1800s is known as the ______ Shogunate.", "acceptedAnswers": ["Tokugawa"], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-66", "num": 66, "unit": "unit5", "unitName": "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia", "type": "fill-blank", "prompt": "The last two major dynasties of China were the ______ and ______ dynasties.", "acceptedAnswers": [["Ming"], ["Qing"]], "difficulty": 2, "points": 10, "hint": "U5"}, {"id": "wh-67", "num": 67, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The three major early civilizations of the Americas were the ______ in Mesoamerica, the ______ in central Mexico, and the ______ in the Andes.", "acceptedAnswers": [["Maya"], ["Aztec"], ["Inca"]], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-68", "num": 68, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The Aztecs built ‚Äúfloating gardens‚Äù on Lake Texcoco known as ______ to increase farmland.", "acceptedAnswers": ["Chinampas"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-69", "num": 69, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The Inca kept records using knotted strings called ______.", "acceptedAnswers": ["Quipu"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-70", "num": 70, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "Spanish conquerors who defeated Native American empires were called ______.", "acceptedAnswers": ["Conquistadors"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-71", "num": 71, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The Spanish conquistador who defeated the Aztec Empire was Hern√°n ______, while ______ ______ conquered the Inca.", "acceptedAnswers": [["Cort√©s", "Cortes"], ["Francisco"], ["Pizarro"]], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-72", "num": 72, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The exchange of plants, animals, diseases, and people between the Old World and the New World is called the ______ ______.", "acceptedAnswers": [["Columbian"], ["Exchange"]], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-73", "num": 73, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The forced voyage of enslaved Africans across the Atlantic Ocean to the Americas was known as the ______ ______.", "acceptedAnswers": [["Middle"], ["Passage"]], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-74", "num": 74, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The economic system in which colonies exist to benefit the mother country by supplying raw materials and markets is called ______.", "acceptedAnswers": ["Mercantilism"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-75", "num": 75, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The three-part trade route between Europe, Africa, and the Americas is known as ______ trade.", "acceptedAnswers": ["Triangular"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-76", "num": 76, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The rigid labor system in Spanish colonies that granted colonists the right to demand labor from Native Americans was called the ______ system.", "acceptedAnswers": ["Encomienda"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-77", "num": 77, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "Explorers could sail farther and faster using improved ships called ______ that used lateen sails.", "acceptedAnswers": ["Caravels"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-78", "num": 78, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "Two important navigational tools that helped exploration were the magnetic ______ and the ______, which measured latitude using the stars.", "acceptedAnswers": [["Compass"], ["Astrolabe"]], "difficulty": 2, "points": 10, "hint": "U6", "unordered": true}, {"id": "wh-79", "num": 79, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The Treaty of ______ divided newly discovered lands outside Europe between Spain and Portugal.", "acceptedAnswers": ["Tordesillas"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-80", "num": 80, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "The blending of indigenous and European cultures and religions in the Americas is an example of cultural ______.", "acceptedAnswers": ["Diffusion", "Syncretism"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-81", "num": 81, "unit": "unit6", "unitName": "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization", "type": "fill-blank", "prompt": "European diseases like smallpox caused a massive population ______ among indigenous peoples of the Americas.", "acceptedAnswers": ["Decline", "Collapse", "Decimation"], "difficulty": 2, "points": 10, "hint": "U6"}, {"id": "wh-82", "num": 82, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The Polish astronomer ______ proposed a heliocentric model of the universe with the sun at the center.", "acceptedAnswers": ["Copernicus"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-83", "num": 83, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The Italian scientist ______ used a telescope to support the heliocentric theory and was tried by the Inquisition.", "acceptedAnswers": ["Galileo"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-84", "num": 84, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The English scientist ______ ______ developed the law of gravity and helped explain motion in the universe.", "acceptedAnswers": [["Isaac"], ["Newton"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-85", "num": 85, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "A step-by-step process of experimentation and observation used to test ideas is called the ______ ______.", "acceptedAnswers": [["Scientific"], ["Method"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-86", "num": 86, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "Enlightenment thinkers such as Voltaire and ______ used reason to criticize absolute monarchy and traditional authority.", "acceptedAnswers": ["Rousseau", "Diderot"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-87", "num": 87, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "John ______ argued that people have natural rights to life, liberty, and property.", "acceptedAnswers": ["Locke"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-88", "num": 88, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "Montesquieu believed that government power should be divided among three branches, a concept known as ______ of ______.", "acceptedAnswers": [["Separation"], ["Powers"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-89", "num": 89, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "A voluntary agreement in which people give up some freedoms in exchange for an organized society is known as a social ______.", "acceptedAnswers": ["Contract"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-90", "num": 90, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "Absolute monarchs who adopted some Enlightenment ideas were called ______ ______.", "acceptedAnswers": [["Enlightened"], ["Despots"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-91", "num": 91, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "In 1776, American colonists declared independence from ______ in a document known as the ______ of Independence.", "acceptedAnswers": [["Britain"], ["Declaration"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-92", "num": 92, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The French Revolution began in 1789 when members of the Third Estate formed the ______ Assembly.", "acceptedAnswers": ["National"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-93", "num": 93, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The storming of the ______ on July 14, 1789, became a powerful symbol of the French Revolution.", "acceptedAnswers": ["Bastille"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-94", "num": 94, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "A radical phase of the French Revolution marked by mass executions under Robespierre is called the Reign of ______.", "acceptedAnswers": ["Terror"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-95", "num": 95, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "The military leader who rose to power after the French Revolution and became emperor of France was ______ ______.", "acceptedAnswers": [["Napoleon"], ["Bonaparte"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-96", "num": 96, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "In Latin America, leaders such as Sim√≥n ______ and Jos√© de San Mart√≠n fought for independence from ______ colonial rule.", "acceptedAnswers": [["Bolivar"], ["Spanish"]], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-97", "num": 97, "unit": "unit7", "unitName": "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions", "type": "fill-blank", "prompt": "After Napoleon‚Äôs defeat, European leaders met at the Congress of ______ to restore balance of power.", "acceptedAnswers": ["Vienna"], "difficulty": 2, "points": 10, "hint": "U7"}, {"id": "wh-98", "num": 98, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The Industrial Revolution began in the country of ______ ______ in the late 1700s.", "acceptedAnswers": [["Great"], ["Britain"]], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-99", "num": 99, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The first industry to be transformed by machines was the ______ industry.", "acceptedAnswers": ["Textile"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-100", "num": 100, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "A machine that used coal to power engines and factories was the ______ engine.", "acceptedAnswers": ["Steam"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-101", "num": 101, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The movement of people from rural areas to cities is called ______.", "acceptedAnswers": ["Urbanization"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-102", "num": 102, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Crowded neighborhoods with poor housing and sanitation in industrial cities were called ______.", "acceptedAnswers": ["Slums", "Tenements"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-103", "num": 103, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Factories often employed ______ as workers, leading to harsh and dangerous conditions.", "acceptedAnswers": ["Children"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-104", "num": 104, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Organizations formed by workers to demand better wages and working conditions were called ______.", "acceptedAnswers": ["Unions"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-105", "num": 105, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The economic system in which individuals own businesses and operate them for profit is called ______.", "acceptedAnswers": ["Capitalism"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-106", "num": 106, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Karl Marx argued for a classless society and called his ideas ______.", "acceptedAnswers": ["Communism", "Socialism", "Marxism"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-107", "num": 107, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "A strong feeling of pride in and loyalty to one‚Äôs nation is called ______.", "acceptedAnswers": ["Nationalism"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-108", "num": 108, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Leaders who helped unify Germany and Italy in the 1800s included Otto von ______ and Count Camillo di ______.", "acceptedAnswers": [["Bismarck"], ["Cavour"]], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-109", "num": 109, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The rapid modernization of Japan under Emperor Meiji, including industrialization and military reform, is known as the ______ Restoration.", "acceptedAnswers": ["Meiji"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-110", "num": 110, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The domination of one country by another for political and economic gain is called ______.", "acceptedAnswers": ["Imperialism"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-111", "num": 111, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The late-1800s rush by European powers to colonize Africa is often called the ‚ÄúScramble for ______.‚Äù", "acceptedAnswers": ["Africa"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-112", "num": 112, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "At the ______ Conference of 1884‚Äì1885, European powers divided Africa into colonies without regard for ethnic boundaries.", "acceptedAnswers": ["Berlin"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-113", "num": 113, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "In China, the British victory in the ______ Wars led to unequal treaties and spheres of influence.", "acceptedAnswers": ["Opium"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-114", "num": 114, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "The 1857 rebellion by Indian soldiers against British rule, sparked by rumors about rifle cartridges, is known as the ______ Rebellion.", "acceptedAnswers": ["Sepoy"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-115", "num": 115, "unit": "unit8", "unitName": "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism", "type": "fill-blank", "prompt": "Chinese resentment of foreign influence and Christian missionaries led to the ______ Rebellion in 1899.", "acceptedAnswers": ["Boxer"], "difficulty": 2, "points": 10, "hint": "U8"}, {"id": "wh-116", "num": 116, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The four main long-term causes of World War I are often summarized by the acronym MAIN: Militarism, Alliances, ______, and ______.", "acceptedAnswers": [["Imperialism"], ["Nationalism"]], "difficulty": 2, "points": 10, "hint": "U9", "unordered": true}, {"id": "wh-117", "num": 117, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "World War I began in 1914 after the assassination of Archduke ______ ______ in Sarajevo.", "acceptedAnswers": [["Franz"], ["Ferdinand"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-118", "num": 118, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "Fighting from deep ditches along the Western Front is known as ______ warfare.", "acceptedAnswers": ["Trench"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-119", "num": 119, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "A war in which nations devote all their resources to the war effort is called ______ ______.", "acceptedAnswers": [["Total"], ["War"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-120", "num": 120, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The peace agreement that officially ended World War I and blamed Germany for the war was the Treaty of ______.", "acceptedAnswers": ["Versailles"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-121", "num": 121, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The international organization created after World War I to promote peace was called the League of ______.", "acceptedAnswers": ["Nations"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-122", "num": 122, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "In 1917, the ______ Revolution in Russia brought the Bolsheviks to power under Vladimir ______.", "acceptedAnswers": [["Russian"], ["Lenin"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-123", "num": 123, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "Under Joseph ______, the Soviet Union became a totalitarian state with a command economy and forced collectivization.", "acceptedAnswers": ["Stalin"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-124", "num": 124, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "A political movement that emphasizes extreme nationalism, loyalty to the state, and a dictatorial leader is called ______.", "acceptedAnswers": ["Fascism"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-125", "num": 125, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "In Italy, fascism was led by ______ ______, while in Germany it was led by Adolf ______.", "acceptedAnswers": [["Benito"], ["Mussolini"], ["Hitler"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-126", "num": 126, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The severe global economic downturn of the 1930s is known as the Great ______.", "acceptedAnswers": ["Depression"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-127", "num": 127, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The policy of giving in to an aggressor‚Äôs demands to avoid war, used at the 1938 Munich Conference, is called ______.", "acceptedAnswers": ["Appeasement"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-128", "num": 128, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "World War II began in 1939 when Germany invaded ______.", "acceptedAnswers": ["Poland"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-129", "num": 129, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "Germany‚Äôs fast, coordinated attack strategy combining air and ground forces was called ______.", "acceptedAnswers": ["Blitzkrieg"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-130", "num": 130, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The surprise Japanese attack on the U.S. naval base at ______ ______ in 1941 brought the United States into World War II.", "acceptedAnswers": [["Pearl"], ["Harbor"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-131", "num": 131, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The mass genocide of six million Jews and millions of others by the Nazis is known as the ______.", "acceptedAnswers": ["Holocaust"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-132", "num": 132, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "Laws passed in Nazi Germany that stripped Jews of citizenship and rights were called the ______ Laws.", "acceptedAnswers": ["Nuremberg"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-133", "num": 133, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "The Allied invasion of Nazi-occupied France on June 6, 1944, is known as ______-Day.", "acceptedAnswers": ["D"], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-134", "num": 134, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "After World War II, an international organization formed to promote peace and cooperation among nations was the ______ ______.", "acceptedAnswers": [["United"], ["Nations"]], "difficulty": 2, "points": 10, "hint": "U9"}, {"id": "wh-135", "num": 135, "unit": "unit9", "unitName": "Unit 9 ‚Ä¢ World Wars & Global Conflict", "type": "fill-blank", "prompt": "Trials held after the war to prosecute Nazi leaders for crimes against humanity took place in the city of ______.", "acceptedAnswers": ["Nuremberg"], "difficulty": 2, "points": 10, "hint": "U9"}], "extended": []};

const UNIT_META = {
  unit2: "Unit 2 ‚Ä¢ Ancient Civilizations",
  unit3: "Unit 3 ‚Ä¢ Classical Mediterranean Societies & Empires",
  unit4: "Unit 4 ‚Ä¢ Islamic & African Civilizations",
  unit5: "Unit 5 ‚Ä¢ Middle Ages, Renaissance, & East Asia",
  unit6: "Unit 6 ‚Ä¢ Exploration, Conquest, & Colonization",
  unit7: "Unit 7 ‚Ä¢ Scientific Revolution & Political Revolutions",
  unit8: "Unit 8 ‚Ä¢ Industrialization, Nationalism, & Imperialism",
  unit9: "Unit 9 ‚Ä¢ World Wars & Global Conflict",
};

const MODES = [
{"id": "quick", "title": "Quick Quiz", "desc": "Type the answer. Auto‚Äëgraded. Great for practice or whole‚Äëclass review.", "icon": "‚ñ∂"},
{"id": "lightning", "title": "Lightning", "desc": "Multiple‚Äëchoice speed round. 10 questions, timed.", "icon": "‚ö°"},
{"id": "streak", "title": "Streak Sprint", "desc": "60 seconds. Answer as many as you can. Streak boosts points.", "icon": "üî•"},
{"id": "flashcards", "title": "Flashcards", "desc": "Flip, self‚Äërate, and build mastery (simple spaced review).", "icon": "üÉè"},
{"id": "match", "title": "Match‚ÄëUp", "desc": "Match key terms to definitions (pulled from prompts).", "icon": "üß©"},
{"id": "showdown", "title": "Team Showdown", "desc": "Pass‚Äëand‚Äëplay. Teams take turns; optional steals.", "icon": "üèÅ"},
{"id": "mystery", "title": "Mystery Grid", "desc": "Pick tiles to reveal questions. Projector‚Äëfriendly.", "icon": "üü¶"},
{"id": "buzzbowl", "title": "Buzz Bowl", "desc": "Local quiz‚Äëbowl style: teams buzz in, answer, and steal.", "icon": "üîî"},
{"id": "sudden", "title": "Sudden Death", "desc": "Teams are eliminated on a miss. Last team standing wins.", "icon": "üíÄ"},
{"id": "relay", "title": "Relay Sprint", "desc": "Each team gets 30 seconds. Pass the device between teams.", "icon": "üîÅ"},
{"id": "timeline", "title": "Timeline Showdown", "desc": "Drag events into chronological order. Score by accuracy + speed.", "icon": "üóìÔ∏è"},
{"id": "review", "title": "Auto‚Äëgraded Review Guide", "desc": "Fill every blank, then click Grade. Units + Search filters apply.", "icon": "üìù"}
,
{"id": "blitz", "title": "Neon Blitz", "desc": "10-question speed run. Fast points and flashy feedback.", "icon": "‚ö°"},
{"id": "type", "title": "Type‚ÄëIt Sprint", "desc": "Short-answer rush. One minute, as many as you can.", "icon": "‚å®Ô∏è"},
{"id": "boss", "title": "Boss Battle", "desc": "HP bars + hits. Correct answers deal damage; mistakes hurt.", "icon": "üëë"},
{"id": "conquest", "title": "Realm Conquest", "desc": "3√ó3 grid war. Attack adjacent tiles to expand your empire.", "icon": "üó∫Ô∏è"},
{"id": "chrono", "title": "Time Stream", "desc": "Before/After chronology duel. Keep the streak alive.", "icon": "‚è≥"},
{"id": "survival", "title": "Survival", "desc": "Three lives. Stay alive as long as you can.", "icon": "‚ù§Ô∏è"},
{"id": "memory", "title": "Memory Flip", "desc": "Flip cards to match prompt ‚Üî answer pairs.", "icon": "üÉè"},
{"id": "jeopardy", "title": "Jeopardy Grid", "desc": "Pick tiles, answer, earn points. Great for teams.", "icon": "üèÜ"},
{"id": "wager", "title": "Wager Wheel", "desc": "Choose your wager each question. Risk it for big points.", "icon": "üé∞"}
];


const TIMELINE_EVENTS = [
  {
    "id": "tl-1",
    "unit": "unit3",
    "year": 476,
    "title": "fall of the Western Roman Empire"
  },
  {
    "id": "tl-2",
    "unit": "unit3",
    "year": 1054,
    "title": "Christian church split"
  },
  {
    "id": "tl-3",
    "unit": "unit5",
    "year": 1215,
    "title": "English nobles forced King John to sign the Magna Carta"
  },
  {
    "id": "tl-4",
    "unit": "unit7",
    "year": 1776,
    "title": "American colonists declared independence from Britain"
  },
  {
    "id": "tl-5",
    "unit": "unit7",
    "year": 1789,
    "title": "French Revolution began in 1789 when members of the Third Estate formed the National Assembly"
  },
  {
    "id": "tl-6",
    "unit": "unit7",
    "year": 1789,
    "title": "storming of the Bastille on July 14"
  },
  {
    "id": "tl-8",
    "unit": "unit8",
    "year": 1857,
    "title": "1857 rebellion by Indian soldiers against British rule"
  },
  {
    "id": "tl-7",
    "unit": "unit8",
    "year": 1884,
    "title": "At the Berlin Conference of 1884‚Äì1885"
  },
  {
    "id": "tl-9",
    "unit": "unit8",
    "year": 1899,
    "title": "Chinese resentment of foreign influence and Christian missionaries led to the Boxer Rebellion"
  },
  {
    "id": "tl-10",
    "unit": "unit9",
    "year": 1914,
    "title": "World War I began in 1914 after the assassination of Archduke Franz Ferdinand in Sarajevo"
  },
  {
    "id": "tl-11",
    "unit": "unit9",
    "year": 1917,
    "title": "the Russian Revolution in Russia brought the Bolsheviks to power under Vladimir Lenin"
  },
  {
    "id": "tl-12",
    "unit": "unit9",
    "year": 1938,
    "title": "policy of giving in to an aggressor‚Äôs demands to avoid war"
  },
  {
    "id": "tl-13",
    "unit": "unit9",
    "year": 1939,
    "title": "World War II began in 1939 when Germany invaded Poland"
  },
  {
    "id": "tl-14",
    "unit": "unit9",
    "year": 1941,
    "title": "surprise Japanese attack on the U.S. naval base at Pearl Harbor in 1941 brought the United States into World War II"
  },
  {
    "id": "tl-15",
    "unit": "unit9",
    "year": 1944,
    "title": "Allied invasion of Nazi-occupied France on June 6"
  }
];

const STORAGE_KEYS = {
  settings: "whra_settings_v1",
  progress: "whra_progress_v1",
  decks: "whra_decks_v2",
  leitner: "whra_leitner_v1",
  mistakes: "whra_mistakes_v1",
  teams: "whra_teams_v1"
};

const App = {
  decks: null,
  settings: {
    deck: "core",
    play: "solo",
    search: "",
    units: { unit2:true, unit3:true, unit4:true, unit5:true, unit6:true, unit7:true, unit8:true, unit9:true },
    timerOn: false,
    timerSeconds: 30,
    soundOn: false,
    reduceMotion: false,
    showHints: true,
  },
  teams: [
    { name: "Team A", score: 0 },
    { name: "Team B", score: 0 }
  ],
  progress: {}, // by question id => {attempts, correct}
  mistakes: [], // question ids missed recently
  leitner: {},  // id => box 1-4
  session: null // active mode session
};

function $(sel) { return document.querySelector(sel); }
function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
function shuffle(arr) {
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function sample(arr, k) { return shuffle(arr).slice(0, Math.min(k, arr.length)); }
function uniq(arr) { return Array.from(new Set(arr)); }
function normalize(s) {
  return (s||"")
    .toLowerCase()
    .trim()
    .replace(/[‚Äô']/g, "'")
    .replace(/[^a-z0-9\s]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function hasAutoAnswers(q) { return Array.isArray(q.acceptedAnswers) && q.acceptedAnswers.length > 0; }
function isCorrect(q, userAnswer) {
  if (!hasAutoAnswers(q)) return null;

  const unordered = !!q.unordered;

  // Multi-blank: userAnswer is an array of strings, q.acceptedAnswers is an array of arrays (per-blank)
  if (Array.isArray(userAnswer)) {
    const expected = q.acceptedAnswers;
    if (!Array.isArray(expected) || expected.length === 0) return null;

    // If deck isn't nested, fall back to joining typed pieces
    if (!Array.isArray(expected[0])) {
      const joined = normalize(userAnswer.join(" "));
      const accepted = expected.map(a => normalize(a));
      return joined ? accepted.includes(joined) : false;
    }

    const u = userAnswer.map(a => normalize(a)).filter(Boolean);
    if (u.length !== expected.length) return false;

    if (unordered && expected.length > 1) {
      const pools = expected.map(arr => arr.map(a => normalize(a)));
      const remaining = u.slice();
      for (const pool of pools) {
        const idx = remaining.findIndex(x => pool.includes(x));
        if (idx === -1) return false;
        remaining.splice(idx,1);
      }
      return remaining.length===0;
    }

    for (let i = 0; i < expected.length; i++) {
      const ua = normalize(userAnswer[i]);
      if (!ua) return false;
      const accepted = expected[i].map(a => normalize(a));
      if (!accepted.includes(ua)) return false;
    }
    return true;
  }

  // Single-blank
  const ua = normalize(userAnswer);
  if (!ua) return false;

  // If the deck has nested accepted answers but the UI only provided one box, try splitting on commas.
  if (Array.isArray(q.acceptedAnswers[0])) {
    const parts = ua.split(/\s*,\s*/).filter(Boolean);
    const expected = q.acceptedAnswers;
    if (parts.length !== expected.length) return false;

    if (unordered && expected.length > 1) {
      const pools = expected.map(arr => arr.map(a => normalize(a)));
      const remaining = parts.map(x=>normalize(x));
      for (const pool of pools) {
        const idx = remaining.findIndex(x => pool.includes(x));
        if (idx === -1) return false;
        remaining.splice(idx,1);
      }
      return remaining.length===0;
    }

    for (let i = 0; i < expected.length; i++) {
      const accepted = expected[i].map(a => normalize(a));
      if (!accepted.includes(normalize(parts[i]))) return false;
    }
    return true;
  }

  const accepted = q.acceptedAnswers.map(a => normalize(a));
  return accepted.includes(ua);
}
function toast(title, msg) {
  $("#toastTitle").textContent = title;
  $("#toastMsg").textContent = msg || "";
  $("#toast").classList.remove("hidden");
}
function toastHide() { $("#toast").classList.add("hidden"); }

function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw);
  } catch {
    return fallback;
  }
}

function persist() {
  saveJSON(STORAGE_KEYS.settings, App.settings);
  saveJSON(STORAGE_KEYS.progress, App.progress);
  saveJSON(STORAGE_KEYS.leitner, App.leitner);
  saveJSON(STORAGE_KEYS.mistakes, App.mistakes);
  saveJSON(STORAGE_KEYS.teams, App.teams);
  saveJSON(STORAGE_KEYS.decks, App.decks);
}

function load() {
  App.settings = Object.assign(App.settings, loadJSON(STORAGE_KEYS.settings, {}));
  App.progress = loadJSON(STORAGE_KEYS.progress, {});
  App.leitner = loadJSON(STORAGE_KEYS.leitner, {});
  App.mistakes = loadJSON(STORAGE_KEYS.mistakes, []);
  App.teams = loadJSON(STORAGE_KEYS.teams, App.teams);  const savedDecks = loadJSON(STORAGE_KEYS.decks, null);

  // If a previous version saved a partial/incorrect deck, automatically restore the built-in World History deck.
  const expectedCore = Array.isArray(DEFAULT_DECKS?.core) ? DEFAULT_DECKS.core.length : 0;
  const savedCore = Array.isArray(savedDecks?.core) ? savedDecks.core.length : 0;
  const looksLikeWorldHistory = Array.isArray(savedDecks?.core) && savedDecks.core.every(q => String(q?.id || "").startsWith("wh-"));
  const validSaved = !!savedDecks && looksLikeWorldHistory && savedCore === expectedCore;

  App.decks = validSaved ? savedDecks : JSON.parse(JSON.stringify(DEFAULT_DECKS)); // deep clone
  if (!validSaved) {
    // overwrite bad saved decks so you don't keep seeing the wrong/partial question set
    saveJSON(STORAGE_KEYS.decks, App.decks);
  }
}

load();

// Normalize settings (helps if you previously used a different version of the arcade)
(() => {
  // Deck: only Core exists in this build
  App.settings.deck = "core";

  // Units: keep only World History units (2‚Äì9) and default to ON
  const keep = ["unit2","unit3","unit4","unit5","unit6","unit7","unit8","unit9"];
  const prev = App.settings.units || {};
  const next = {};
  keep.forEach(u => next[u] = (u in prev) ? !!prev[u] : true);
  App.settings.units = next;

  // Teams: at least 2
  if (!Array.isArray(App.teams) || App.teams.length < 2) {
    App.teams = [{name:"Team A",score:0},{name:"Team B",score:0}];
  }
  persist();
})();

/** ========= Navigation ========= */
function setNav(view) {
  const views = ["home","modes","progress","settings","game"];
  for (const v of views) {
    const el = document.getElementById("view-"+v);
    if (!el) continue;
    el.classList.toggle("hidden", v !== view);
  }
  $all("nav .pill").forEach(btn => btn.classList.toggle("active", btn.dataset.nav === view));
  if (view !== "game") App.session = null;
  renderAll();
}
$all("nav .pill").forEach(btn => btn.addEventListener("click", () => setNav(btn.dataset.nav)));

/** ========= Filters ========= */
function syncHomeControls() {
  $("#deckSelect").value = App.settings.deck;
  $("#playSelect").value = App.settings.play;
  $all("[data-unit]").forEach(b => {
    const u = b.dataset.unit;
    b.classList.toggle("active", !!App.settings.units[u]);
  });
  const si = $("#searchInput");
  if (si) si.value = App.settings.search || "";
  $("#btnTeams").style.display = (App.settings.play === "teams") ? "" : "none";
}
$("#deckSelect").addEventListener("change", (e) => { App.settings.deck = e.target.value; persist(); renderAll(); });
$("#playSelect").addEventListener("change", (e) => { App.settings.play = e.target.value; persist(); syncHomeControls(); });

const __si = $("#searchInput");
if (__si) {
  __si.addEventListener("input", (e) => { App.settings.search = e.target.value; persist(); renderAll(); });
}


$all("[data-unit]").forEach(b => {
  b.addEventListener("click", () => {
    const u = b.dataset.unit;
    App.settings.units[u] = !App.settings.units[u];
    persist();
    syncHomeControls();
    renderAll();
  });
});

function selectedUnits() { return Object.keys(App.settings.units).filter(u => App.settings.units[u]); }

function getQuestionPool() {
  const deck = App.settings.deck;
  const units = new Set(selectedUnits());
  const term = normalize(App.settings.search || "");
  let qs = [];
  if (deck === "core" || deck === "both") qs = qs.concat(App.decks.core);
  if (deck === "extended" || deck === "both") qs = qs.concat(App.decks.extended);

  qs = qs.filter(q => units.has(q.unit));

  if (term) {
    qs = qs.filter(q => {
      const hay = [
        q.prompt || "",
        q.unitName || "",
        q.hint || "",
        Array.isArray(q.acceptedAnswers) ? JSON.stringify(q.acceptedAnswers) : ""
      ].join(" ");
      return normalize(hay).includes(term);
    });
  }
  return qs;
}
function countAutogradable(qs) { return qs.filter(q => hasAutoAnswers(q)).length; }

/** ========= Progress ========= */
function recordAttempt(q, correct) {
  const id = q.id;
  const p = App.progress[id] || { attempts:0, correct:0 };
  p.attempts += 1;
  if (correct) p.correct += 1;
  App.progress[id] = p;

  if (!correct) App.mistakes = [id, ...App.mistakes.filter(x => x!==id)].slice(0, 80);
  else App.mistakes = App.mistakes.filter(x => x!==id);

  persist();
}
function masteryForUnit(unitKey) {
  const qs = getQuestionPool().filter(q => q.unit === unitKey);
  if (!qs.length) return {unitKey, total:0, correct:0, attempts:0, rate:0};
  let attempts=0, correct=0;
  for (const q of qs) {
    const p = App.progress[q.id];
    if (!p) continue;
    attempts += p.attempts;
    correct += p.correct;
  }
  return { unitKey, total: qs.length, correct, attempts, rate: attempts ? (correct/attempts) : 0 };
}

/** ========= Modal ========= */
function showModal(title, bodyHTML) {
  $("#modalTitle").textContent = title;
  $("#modalBody").innerHTML = bodyHTML;
  $("#modal").classList.add("show");
}
function closeModal() {
  $("#modal").classList.remove("show");
  $("#modalBody").innerHTML = "";
}
$("#modalClose").addEventListener("click", closeModal);
$("#modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });

/** ========= Teams editor ========= */
function escapeHtml(s) {
  return (s||"").replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));
}
$("#btnTeams").addEventListener("click", () => {
  const rows = App.teams.map((t,i) => `
    <div class="row" style="margin-bottom:10px;">
      <label class="tag">Team ${i+1}</label>
      <input class="input" data-team-name="${i}" value="${escapeHtml(t.name)}" />
      <button class="btn bad" data-remove-team="${i}">Remove</button>
    </div>
  `).join("");

  showModal("Edit teams", `
    <p class="muted">Pass-and-play: teams share one device.</p>
    ${rows}
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="addTeam">Add team</button>
      <button class="btn primary" id="saveTeams">Save</button>
    </div>
  `);

  $("#addTeam").addEventListener("click", () => {
    App.teams.push({ name: `Team ${App.teams.length+1}`, score: 0 });
    persist();
    closeModal();
    $("#btnTeams").click();
  });
  $all("[data-remove-team]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = Number(btn.dataset.removeTeam);
      if (App.teams.length <= 2) { toast("Need at least 2 teams", "Add more teams instead of removing below 2."); return; }
      App.teams.splice(i,1);
      persist();
      closeModal();
      $("#btnTeams").click();
    });
  });
  $("#saveTeams").addEventListener("click", () => {
    $all("[data-team-name]").forEach(inp => {
      const i = Number(inp.dataset.teamName);
      App.teams[i].name = inp.value.trim() || `Team ${i+1}`;
    });
    persist();
    toast("Teams saved", `${App.teams.length} teams ready.`);
    closeModal();
    syncHomeControls();
    renderAll();
  });
});

/** ========= Settings ========= */
function syncSettingsUI() {
  $("#timerMode").value = App.settings.timerOn ? "on" : "off";
  $("#timerSeconds").value = App.settings.timerSeconds;
  $("#soundMode").value = App.settings.soundOn ? "on" : "off";
  $("#motionMode").value = App.settings.reduceMotion ? "on" : "off";
  $("#hintMode").value = App.settings.showHints ? "on" : "off";
}
$("#btnSaveSettings").addEventListener("click", () => {
  App.settings.timerOn = $("#timerMode").value === "on";
  App.settings.timerSeconds = clamp(Number($("#timerSeconds").value || 30), 10, 120);
  App.settings.soundOn = $("#soundMode").value === "on";
  App.settings.reduceMotion = $("#motionMode").value === "on";
  App.settings.showHints = $("#hintMode").value === "on";

  // Apply timer changes immediately if a game is in progress.
  if (App.session) {
    if (!App.settings.timerOn) {
      stopTimer();
      $("#timerBadge").textContent = "‚è± Off";
    } else {
      // If timer was turned on mid-game, restart appropriately.
      if (!["review","match","flashcards","timeline","mystery"].includes(App.session.modeId)) {
        if (!["streak","relay"].includes(App.session.modeId)) {
          App.session.timeLeft = App.settings.timerSeconds;
        }
        startTimer();
      }
    }
  }

  persist();
  toast("Settings saved", "Your preferences were saved on this device.");
  renderAll();
});

if ($("#btnOpenEditor")) $("#btnOpenEditor").addEventListener("click", () => {
  const example = {
    id: "custom-1",
    unit: "unit2",
    unitName: "Ancient Civilizations",
    type: "fill-blank",
    prompt: "The writing system developed in Mesopotamia was called ____________.",
    acceptedAnswers: ["Cuneiform"],
    difficulty: 2,
    points: 10,
    hint: "Unit 2"
  };
  showModal("Question editor (JSON)", `
    <p class="muted">Paste a question object or an array. If an id already exists, it will be replaced. If id starts with <code>core-</code>, it updates Core; otherwise Extended.</p>
    <textarea id="editorArea">${escapeHtml(JSON.stringify(example, null, 2))}</textarea>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="applyEditor">Apply</button>
      <button class="btn" id="exportDecks">Copy all decks</button>
    </div>
  `);
  $("#applyEditor").addEventListener("click", () => {
    try {
      const obj = JSON.parse($("#editorArea").value);
      const items = Array.isArray(obj) ? obj : [obj];
      for (const it of items) {
        if (!it.id || !it.prompt || !it.unit) throw new Error("Each question needs id, prompt, and unit.");
        const target = it.id.startsWith("core-") ? App.decks.core : App.decks.extended;
        const idx = target.findIndex(q => q.id === it.id);
        if (idx >= 0) target[idx] = it;
        else target.push(it);
      }
      persist();
      toast("Questions updated", `${items.length} question(s) applied.`);
      closeModal();
      renderAll();
    } catch (e) {
      toast("Invalid JSON", e.message || "Could not parse.");
    }
  });
  $("#exportDecks").addEventListener("click", async () => {
    const data = JSON.stringify(App.decks, null, 2);
    await navigator.clipboard?.writeText?.(data);
    toast("Copied", "All decks JSON copied to clipboard (if your browser allows).");
  });
});
if ($("#btnRestoreQuestions")) $("#btnRestoreQuestions").addEventListener("click", () => {
  App.decks = JSON.parse(JSON.stringify(DEFAULT_DECKS));
  persist();
  toast("Restored", "Default Core + Extended decks restored.");
  renderAll();
});

/** ========= Import / Export ========= */
$("#btnExport").addEventListener("click", async () => {
  const payload = { version: 1, settings: App.settings, progress: App.progress, leitner: App.leitner, mistakes: App.mistakes, teams: App.teams, decks: App.decks };
  const txt = JSON.stringify(payload, null, 2);
  showModal("Export (copy/paste)", `
    <p class="muted">Copy this JSON to save or move to another device.</p>
    <textarea id="exportArea">${escapeHtml(txt)}</textarea>
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="copyExport">Copy</button>
    </div>
  `);
  $("#copyExport").addEventListener("click", async () => {
    await navigator.clipboard?.writeText?.(txt);
    toast("Copied", "Export JSON copied (if your browser allows).");
  });
});
$("#btnImport").addEventListener("click", () => {
  showModal("Import", `
    <p class="muted">Paste an exported JSON blob here. This will overwrite current progress/settings.</p>
    <textarea id="importArea"></textarea>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="doImport">Import</button>
    </div>
  `);
  $("#doImport").addEventListener("click", () => {
    try {
      const obj = JSON.parse($("#importArea").value);
      if (!obj || obj.version !== 1) throw new Error("Unsupported export version.");
      App.settings = Object.assign(App.settings, obj.settings || {});
      App.progress = obj.progress || {};
      App.leitner = obj.leitner || {};
      App.mistakes = obj.mistakes || [];
      App.teams = obj.teams || App.teams;
      if (obj.decks) App.decks = obj.decks;
      persist();
      toast("Imported", "Your data has been loaded.");
      closeModal();
      renderAll();
    } catch (e) {
      toast("Import failed", e.message || "Invalid JSON.");
    }
  });
});

/** ========= Reset progress ========= */
$("#btnResetProgress").addEventListener("click", () => {
  showModal("Reset progress?", `
    <p class="muted">This clears attempts, mastery, and the mistake bank on this device.</p>
    <div class="row" style="margin-top:12px;">
      <button class="btn bad" id="confirmReset">Yes, reset</button>
      <button class="btn" id="cancelReset">Cancel</button>
    </div>
  `);
  $("#confirmReset").addEventListener("click", () => {
    App.progress = {};
    App.mistakes = [];
    App.leitner = {};
    App.teams.forEach(t => t.score = 0);
    persist();
    closeModal();
    toast("Reset", "Progress cleared.");
    renderAll();
  });
  $("#cancelReset").addEventListener("click", closeModal);
});

/** ========= Mode launcher ========= */
function startMode(modeId, opts={}) {
  // Redirect "showdown" to Quick Quiz with team rules + steals
  if (modeId === "showdown") {
    App.settings.play = "teams";
    persist();
    syncHomeControls();
    return startMode("quick", { label: "Team Showdown" });
  }

  // Competitive local modes default to Teams
  if (["buzzbowl","sudden","relay","timeline"].includes(modeId)) {
    App.settings.play = "teams";
    ensureTeams(2);
    persist();
    syncHomeControls();
  }

  const pool = getQuestionPool();
  if (!pool.length) { toast("No questions selected", "Turn on at least one unit in Home."); return; }
  if (App.settings.play === "teams") App.teams.forEach(t => t.score = 0);

  const mode = MODES.find(m => m.id === modeId);
  App.session = {
    modeId,
    title: mode?.title || modeId,
    pool,
    used: new Set(),
    score: 0,
    streak: 0,
    bestStreak: 0,
    question: null,
    choices: null,
    timeLeft: App.settings.timerSeconds,
    timer: null,
    teamIndex: 0,
    opts
  };
  setNav("game");

  // mode init
  if (modeId === "buzzbowl") { App.session.buzz = { open:true, team:null, used:new Set() }; }
  if (modeId === "sudden") { App.session.aliveTeams = App.teams.map(()=>true); App.session.teamIndex = 0; }
  if (modeId === "relay") { App.session.relay = { team: 0, done: [] }; App.session.teamIndex = 0; App.session.timeLeft = 30; }
  if (modeId === "timeline") { App.session.timeline = null;
  // Arcade imports (offline v11) ‚Äî init mode state
  if (modeId === "blitz") { App.session.blitz = { remaining: 10, correct: 0 }; App.session.timeLeft = App.settings.timerSeconds; }
  if (modeId === "type") { App.session.typeSprint = { correct: 0, wrong: 0 }; App.session.timeLeft = 60; }
  if (modeId === "survival") { App.session.survival = { lives: 3, best: App.bestSurvival||0 }; }
  if (modeId === "boss") { App.session.boss = { playerHP: 100, bossHP: 120, phase: "fight" }; }
  if (modeId === "conquest") { App.session.conquest = { grid: initConquestGrid(), turn: 1, selected: null, msg: "Attack an adjacent tile." }; }
  if (modeId === "jeopardy") { App.session.jeopardy = initJeopardyBoard(); }
  if (modeId === "wager") { App.session.wager = { bank: 0, lastWager: 10 }; }
  if (modeId === "chrono") { App.session.chrono = initChronoStream(); }
 }
  renderGame();

  if (modeId === "streak") App.session.timeLeft = 60;
  if (App.settings.timerOn) startTimer();
  else { stopTimer(); $("#timerBadge").textContent = "‚è± Off"; }
}
$all("[data-start]").forEach(btn => btn.addEventListener("click", () => startMode(btn.dataset.start)));

$("#btnExit").addEventListener("click", () => { stopTimer(); setNav("home"); });

$("#btnReviewMisses").addEventListener("click", () => {
  const pool = getQuestionPool().filter(q => App.mistakes.includes(q.id));
  if (!pool.length) { toast("No misses yet", "Answer some questions first."); return; }
  startMode("quick", { customPool: pool, label: "Review misses" });
});

/** ========= Timer ========= */
function startTimer() {
  stopTimer();
  const s = App.session;
  if (!s) return;

  // Respect Settings: if timer is Off, do not run any countdown.
  if (!App.settings.timerOn) {
    $("#timerBadge").textContent = "‚è± Off";
    return;
  }

  $("#timerBadge").textContent = `‚è± ${s.timeLeft}s`;
  s.timer = setInterval(() => {
    if (!App.session) return;
    App.session.timeLeft -= 1;
    if (App.session.timeLeft <= 0) {
      App.session.timeLeft = 0;
      $("#timerBadge").textContent = `‚è± 0s`;
      onTimeUp();
      return;
    }
    $("#timerBadge").textContent = `‚è± ${App.session.timeLeft}s`;
  }, 1000);
}
function stopTimer() { if (App.session?.timer) clearInterval(App.session.timer); if (App.session) App.session.timer = null; }
function onTimeUp() {
  stopTimer();
  const s = App.session;

  // Mode-specific timeout handler (used by Conquest/Jeopardy overlays, etc.)
  if (s && typeof s.onTimeUp === "function") { try { s.onTimeUp(); } catch(e){} return; }

  if (!s) return;

  if (s.modeId === "relay") { advanceRelayTeam(); return; }

  if (s.modeId === "timeline") {
    toast("‚è±Ô∏è Time", "Submit your timeline now.");
    return;
  }

  if (s.question) {
    recordAttempt(s.question, false);
    if (s.modeId === "sudden" && App.settings.play === "teams" && s.aliveTeams) {
      s.aliveTeams[s.teamIndex] = false;
      const alive = aliveCount(s.aliveTeams);
      if (alive <= 1) { showAfter("Time‚Äôs up", `Correct: ${bestAnswerText(s.question)}.`, "bad"); setTimeout(endSession, 350); return; }
      showAfter("Time‚Äôs up", `Correct: ${bestAnswerText(s.question)}. ${teamLabel(s.teamIndex)} is eliminated.`, "bad");
      return;
    }
    if (s.modeId === "buzzbowl") {
      if (s.buzz) { s.buzz.team = null; s.buzz.open = true; }
      showAfter("Time‚Äôs up", `Correct: ${bestAnswerText(s.question)}.`, "bad");
      return;
    }
    showAfter("Time‚Äôs up", `Correct: ${bestAnswerText(s.question)}.`, "bad");
  }
}

/** subtle optional sound (default off) */
function beepSoft() {
  if (!App.settings.soundOn) return;
  try {
    const audio = new AudioContext();
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = "sine";
    o.frequency.value = 440;
    g.gain.value = 0.03;
    o.connect(g); g.connect(audio.destination);
    o.start();
    setTimeout(() => { o.stop(); audio.close(); }, 70);
  } catch {}
}

/** ========= Rendering ========= */
function renderAll() {
  syncHomeControls();
  syncSettingsUI();
  renderModeGrid();
  renderHomeKpis();
  renderProgress();
  renderAboutKpis();
  if (!$("#view-game").classList.contains("hidden")) renderGame();
}
function renderModeGrid() {
  const grid = $("#modeGrid");
  if (!grid) return;

  // Map each mode to a neon "cabinet" color (matches the Retro‚ÄëFuturistic Cyber‚ÄëArcade theme)
  const colorMap = {
    // Tech / Quiz
    quick: "cyan", type: "cyan", review: "cyan", blitz: "cyan",
    // Speed / Timeline
    lightning: "yellow", streak: "yellow", chrono: "yellow", timeline: "yellow",
    // Memory / Cards
    flashcards: "purple", match: "purple", memory: "purple",
    // Strategy / Grids
    conquest: "emerald", mystery: "emerald",
    // Competitive / Buzzers
    showdown: "pink", jeopardy: "pink", buzzbowl: "pink", sudden: "pink", relay: "pink",
    // Combat / Survival
    boss: "red", survival: "red",
    // Risk
    wager: "orange",
  };

  grid.innerHTML = MODES.map(m => {
    const c = colorMap[m.id] || "cyan";
    return `
      <div class="modeCard" data-start="${m.id}" data-color="${c}">
        <div class="row" style="justify-content:space-between;">
          <h3>${m.icon} ${escapeHtml(m.title)}</h3>
          <span class="tag">${escapeHtml(App.settings.play === "teams" ? "Teams" : "Solo")}</span>
        </div>
        <p>${escapeHtml(m.desc)}</p>
      </div>
    `;
  }).join("");

  $all("#modeGrid [data-start]").forEach(el => el.addEventListener("click", () => startMode(el.dataset.start)));
}
function renderHomeKpis() {
  const pool = getQuestionPool();
  const auto = countAutogradable(pool);
  let attempts=0, correct=0;
  for (const id in App.progress) { attempts += App.progress[id]?.attempts || 0; correct += App.progress[id]?.correct || 0; }
  $("#homeKpis").innerHTML = `
    <div class="chip"><strong>${pool.length}</strong> questions selected</div>
    <div class="chip"><strong>${auto}</strong> auto‚Äëgraded</div>
    <div class="chip"><strong>${attempts ? Math.round((correct/attempts)*100) : 0}%</strong> overall accuracy</div>
    <div class="chip"><strong>${App.mistakes.length}</strong> in mistake bank</div>
  `;
}
function renderAboutKpis() {
  $("#aboutKpis").innerHTML = `
    <div class="chip"><strong>${App.decks.core.length}</strong> core questions</div>
    <div class="chip"><strong>${App.decks.extended.length}</strong> extended prompts</div>
    <div class="chip"><strong>${new Date().toLocaleDateString()}</strong> local date</div>
  `;
}
function renderProgress() {
  const container = $("#masteryBars");
  if (!container) return;
  const units = Object.keys(UNIT_META).filter(u => App.settings.units[u]);
  container.innerHTML = units.map(u => {
    const m = masteryForUnit(u);
    const pct = Math.round(m.rate * 100);
    return `
      <div style="margin-bottom:12px;">
        <div class="row" style="justify-content:space-between; margin-bottom:6px;">
          <div style="font-weight:900;">${escapeHtml(UNIT_META[u])}</div>
          <div class="muted">${m.attempts ? `${pct}% accuracy ‚Ä¢ ${m.correct}/${m.attempts} correct` : "No attempts yet"}</div>
        </div>
        <div class="bar"><i style="width:${pct}%;"></i></div>
      </div>
    `;
  }).join("");

  const pool = getQuestionPool();
  const total = pool.length;
  const auto = countAutogradable(pool);
  let attempts=0, correct=0;
  for (const id in App.progress) { attempts += App.progress[id]?.attempts || 0; correct += App.progress[id]?.correct || 0; }
  const overall = attempts ? Math.round((correct/attempts)*100) : 0;
  $("#statsTable").innerHTML = `
    <tr><th>Metric</th><th class="right">Value</th></tr>
    <tr><td>Total selected</td><td class="right">${total}</td></tr>
    <tr><td>Auto-graded</td><td class="right">${auto}</td></tr>
    <tr><td>Attempts</td><td class="right">${attempts}</td></tr>
    <tr><td>Correct</td><td class="right">${correct}</td></tr>
    <tr><td>Accuracy</td><td class="right">${overall}%</td></tr>
    <tr><td>Mistake bank</td><td class="right">${App.mistakes.length}</td></tr>
  `;
}
function bestAnswerText(q) {
  if (!hasAutoAnswers(q)) return "Self-check";
  const a = q.acceptedAnswers;

  // Multi-blank: show the primary answer for each blank
  if (Array.isArray(a[0])) {
    return a.map(x => (x && x.length ? x[0] : "‚Äî")).join(" / ");
  }

  const first = a.slice(0,2);
  return first.join(" / ") + (a.length>2 ? " ‚Ä¶" : "");
}
function formatPrompt(q) {
  const txt = escapeHtml(q.prompt || "");
  return txt.replace(/_{5,}/g, `<span class="blank">______</span>`);
}
function renderScoreStrip() {
  const s = App.session;
  if (!s) return;
  const pool = s.opts.customPool || s.pool;
  const used = s.used?.size || 0;
  const total = pool.length;

  $("#scoreLeft").innerHTML = [
    `<span class="badge">Q: ${used}/${total}</span>`,
    `<span class="badge">Score: ${s.score}</span>`,
    (s.modeId === "streak") ? `<span class="badge">Streak: ${s.streak} (best ${s.bestStreak})</span>` : "" ,
    (s.modeId === "sudden" && s.aliveTeams) ? `<span class="badge">Alive: ${aliveCount(s.aliveTeams)}/${s.aliveTeams.length}</span>` : ""
  ].filter(Boolean).join("");

  if (App.settings.play === "teams") {
    const scores = App.teams.map((t)=>`<span class="badge">${escapeHtml(t.name)}: ${t.score}</span>`).join("");
    $("#scoreRight").innerHTML = `<span class="badge">Turn: ${escapeHtml(App.teams[s.teamIndex]?.name || "Team")}</span>` + scores;
  } else {
    $("#scoreRight").innerHTML = s.opts.label ? `<span class="badge">${escapeHtml(s.opts.label)}</span>` : "";
  }
}
function pickNextQuestion() {
  const s = App.session;
  if (!s) return null;
  const pool = s.opts.customPool || s.pool;

  let candidates = pool.filter(q => !s.used.has(q.id));
  if (!candidates.length) {
    // In Streak Sprint, loop the deck if you run out of questions before time ends
    if (s.modeId === "streak") {
      s.used = new Set();
      candidates = pool.slice();
    } else {
      return null;
    }
  }

  // adaptive: prefer lower accuracy
  candidates = shuffle(candidates).sort((a,b) => {
    const pa = App.progress[a.id] || {attempts:0, correct:0};
    const pb = App.progress[b.id] || {attempts:0, correct:0};
    const ra = pa.attempts ? (pa.correct/pa.attempts) : 0.5;
    const rb = pb.attempts ? (pb.correct/pb.attempts) : 0.5;
    return ra - rb;
  });
  return candidates[0];
}

/** ========= Game rendering ========= */

/** ========= Local multiplayer helpers ========= */
function ensureTeams(minTeams=2) {
  if (!Array.isArray(App.teams) || App.teams.length < minTeams) {
    App.teams = Array.from({length:minTeams}, (_,i)=>({ name:`Team ${String.fromCharCode(65+i)}`, score:0 }));
  }
}
function aliveCount(arr){ return arr.filter(Boolean).length; }
function nextAliveIndex(alive, from) {
  if (!alive || !alive.length) return 0;
  let i = from;
  for (let step=0; step<alive.length; step++) {
    i = (i+1) % alive.length;
    if (alive[i]) return i;
  }
  return from;
}
function teamLabel(i){ return escapeHtml(App.teams?.[i]?.name || `Team ${i+1}`); }



/** ========= Auto-graded Review Guide ========= */
function renderReviewGuide() {
  const s = App.session;
  if (!s) return;
  const pool = (s.opts?.customPool || s.pool || []).slice().sort((a,b)=>(a.num||0)-(b.num||0));

  stopTimer();
  $("#timerBadge").textContent = "‚è± Off";
  $("#afterControls").classList.add("hidden");
  $("#afterControls").innerHTML = "";
  $("#scoreRight").innerHTML = "";
  $("#scoreLeft").innerHTML = `
    <span class="chip">Questions: <strong>${pool.length}</strong></span>
    <span class="chip" id="reviewScoreChip">Not graded</span>
  `;

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <div style="font-weight:800; font-size:18px;">üìù Auto‚Äëgraded Review Guide</div>
        <div class="mini muted">Fill every blank, then click <strong>Grade</strong>. Units + Search filters apply.</div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap;">
        <button class="btn" id="btnReviewPrint">üñ® Print</button>
        <button class="btn" id="btnReviewClear">Clear</button>
        <button class="btn primary" id="btnReviewGrade">Grade</button>
      </div>
    </div>
  `;

  const renderRow = (q) => {
    const safe = escapeHtml(q.prompt || "");
    let i = 0;
    const withInputs = safe.replace(/_{5,}/g, () => {
      const idx = i++;
      return `<input class="input blank-inline" data-qid="${q.id}" data-blank="${idx}" aria-label="Blank ${idx+1} for question ${q.num}" />`;
    });
    return `
      <div class="reviewQ" id="rq_${q.id}">
        <div class="reviewQTop">
          <span class="tag">#${q.num}</span>
          <span class="mini muted">${escapeHtml(q.hint || "")}</span>
          <span class="badge small reviewVerdict" data-qid="${q.id}"></span>
        </div>
        <div class="reviewPrompt">${withInputs}</div>
        <div class="mini muted reviewFeedback" data-qid="${q.id}"></div>
      </div>
    `;
  };

  $("#gameControls").innerHTML = `
    <div class="reviewWrap">
      ${pool.map(renderRow).join("")}
    </div>
  `;

  // Wire controls
  $("#btnReviewPrint").addEventListener("click", () => window.print());
  $("#btnReviewClear").addEventListener("click", () => {
    $all(".blank-inline").forEach(inp => inp.value = "");
    $all(".reviewQ").forEach(row => row.classList.remove("correct","wrong"));
    $all(".reviewVerdict").forEach(b => { b.textContent=""; b.classList.remove("good","bad"); });
    $all(".reviewFeedback").forEach(f => f.textContent="");
    const chip = $("#reviewScoreChip");
    if (chip) chip.textContent = "Not graded";
    toast("Cleared", "All blanks reset.");
  });

  $("#btnReviewGrade").addEventListener("click", () => {
    let correct = 0;
    let total = 0;

    // batch update progress/mistakes and persist once
    const newMistakes = App.mistakes.slice();
    const progressUpdates = {};

    const markMistake = (id) => {
      const filtered = newMistakes.filter(x => x !== id);
      newMistakes.splice(0, newMistakes.length, id, ...filtered);
      if (newMistakes.length > 80) newMistakes.length = 80;
    };
    const clearMistake = (id) => {
      const idx = newMistakes.indexOf(id);
      if (idx >= 0) newMistakes.splice(idx,1);
    };

    pool.forEach(q => {
      const inputs = $all(`input[data-qid="${q.id}"]`);
      let userAnswer = "";
      if (Array.isArray(q.acceptedAnswers?.[0])) {
        userAnswer = inputs.map(i => i.value);
      } else {
        userAnswer = (inputs[0]?.value || "");
      }

      const verdict = isCorrect(q, userAnswer);
      total++;

      const row = $(`#rq_${q.id}`);
      const badge = row?.querySelector(".reviewVerdict");
      const feedback = row?.querySelector(".reviewFeedback");

      row?.classList.remove("correct","wrong");
      badge?.classList.remove("good","bad");

      if (verdict) {
        correct++;
        row?.classList.add("correct");
        if (badge) { badge.textContent = "‚úî"; badge.classList.add("good"); }
        if (feedback) feedback.textContent = "";
      } else {
        row?.classList.add("wrong");
        if (badge) { badge.textContent = "‚úñ"; badge.classList.add("bad"); }
        if (feedback) feedback.innerHTML = `Correct: <strong>${escapeHtml(bestAnswerText(q))}</strong>`;
      }

      // progress update
      const id = q.id;
      const p = (progressUpdates[id] || App.progress[id] || {attempts:0, correct:0});
      p.attempts += 1;
      if (verdict) p.correct += 1;
      progressUpdates[id] = p;

      if (!verdict) markMistake(id);
      else clearMistake(id);
    });

    // commit batch
    Object.entries(progressUpdates).forEach(([id,p]) => App.progress[id] = p);
    App.mistakes = newMistakes;
    persist();

    const pct = total ? Math.round((correct/total)*100) : 0;
    const chip = $("#reviewScoreChip");
    if (chip) chip.innerHTML = `<strong>${correct}/${total}</strong> (${pct}%)`;

    toast("Graded", `${correct}/${total} correct (${pct}%).`);
    renderHomeKpis(); renderProgress(); renderAboutKpis();
  });

  // quick: Ctrl/Cmd+Enter to grade
  document.addEventListener("keydown", function reviewKey(e){
    if (!App.session || App.session.modeId !== "review") { document.removeEventListener("keydown", reviewKey); return; }
    const isMac = navigator.platform.toLowerCase().includes("mac");
    if ((isMac ? e.metaKey : e.ctrlKey) && e.key === "Enter") {
      e.preventDefault();
      $("#btnReviewGrade")?.click();
    }
  });
}

/** ========= Timeline mode ========= */
function pickTimelineSet() {
  const units = new Set(selectedUnits());
  const pool = TIMELINE_EVENTS.filter(e => units.has(e.unit));
  const src = pool.length ? pool : TIMELINE_EVENTS;
  const n = Math.min(8, src.length);
  return sample(src, n);
}
function renderTimeline() {
  const s = App.session;
  if (!s) return;
  ensureTeams(2);

  if (!s.timeline) {
    s.timeline = {
      round: 0,
      rounds: 5,
      teamTurn: 0,
      events: pickTimelineSet().map(e => ({...e})),
      order: [],
      startedAt: Date.now(),
      submitted: false
    };
    s.timeline.order = s.timeline.events.map(e => e.id);
  }

  const tl = s.timeline;
  const teamName = (App.settings.play==="teams") ? teamLabel(tl.teamTurn) : "You";

  $("#prompt").innerHTML = `<div style="font-weight:950;font-size:18px;">üóìÔ∏è Timeline Showdown</div>
    <div class="muted" style="margin-top:6px;">Round ${tl.round+1}/${tl.rounds} ‚Ä¢ ${escapeHtml(teamName)} orders the events earliest ‚Üí latest.</div>`;

  const byId = new Map(tl.events.map(e => [e.id, e]));
  const list = tl.order.map(id => byId.get(id)).filter(Boolean);

  $("#gameControls").innerHTML = `
    <div class="timelineWrap">
      <div class="notice">
        <div style="font-weight:900;">How to play</div>
        <div class="mini">Drag the ‚ò∞ handle to reorder, or use ‚ñ≤‚ñº. Then press Submit.</div>
      </div>
      <div class="timelineList" id="tlList">
        ${list.map((e)=>`
          <div class="tlCard" draggable="true" data-id="${e.id}">
            <div class="tlHandle" title="Drag to reorder">‚ò∞</div>
            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
              <div class="tlTitle">${escapeHtml(e.title)}</div>
              <div class="tlMini">Unit ${escapeHtml(e.unit.replace("unit",""))}</div>
            </div>
            <div class="tlTools">
              <button class="iconBtn" data-move="-1" title="Move up">‚ñ≤</button>
              <button class="iconBtn" data-move="1" title="Move down">‚ñº</button>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="row">
        <button class="btn primary" id="tlSubmit">Submit</button>
        <button class="btn" id="tlNew">New set</button>
      </div>
      <div class="mini">Scoring: +2 per event in the correct position, +3 bonus for perfect. Faster teams win ties.</div>
    </div>
  `;

  // Up/down
  $all("#tlList .tlCard").forEach((card) => {
    card.querySelectorAll("[data-move]").forEach(btn => {
      btn.addEventListener("click", () => {
        const dir = Number(btn.dataset.move);
        const i = tl.order.indexOf(card.dataset.id);
        const j = i + dir;
        if (j < 0 || j >= tl.order.length) return;
        const tmp = tl.order[i]; tl.order[i] = tl.order[j]; tl.order[j] = tmp;
        renderTimeline();
      });
    });
  });

  // Drag & drop
  let dragId = null;
  $all("#tlList .tlCard").forEach(card => {
    card.addEventListener("dragstart", (ev) => {
      dragId = card.dataset.id;
      ev.dataTransfer.setData("text/plain", dragId);
      card.style.opacity = "0.6";
    });
    card.addEventListener("dragend", () => { dragId=null; card.style.opacity="1"; });
    card.addEventListener("dragover", (ev) => ev.preventDefault());
    card.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const targetId = card.dataset.id;
      const id = dragId || ev.dataTransfer.getData("text/plain");
      if (!id || id === targetId) return;
      const from = tl.order.indexOf(id);
      const to = tl.order.indexOf(targetId);
      if (from === -1 || to === -1) return;
      tl.order.splice(from, 1);
      tl.order.splice(to, 0, id);
      renderTimeline();
    });
  });

  $("#tlNew").addEventListener("click", () => { s.timeline = null; renderGame(); });

  $("#tlSubmit").addEventListener("click", () => {
    if (tl.submitted) return;
    tl.submitted = true;

    const correct = tl.events.slice().sort((a,b)=>a.year-b.year).map(e => e.id);
    let correctPos = 0;
    for (let i=0; i<correct.length; i++) if (tl.order[i] === correct[i]) correctPos++;
    let points = correctPos * 2 + ((correctPos === correct.length) ? 3 : 0);

    const elapsed = (Date.now() - tl.startedAt) / 1000;
    const speedTag = elapsed < 25 ? "‚ö° Fast" : (elapsed < 45 ? "‚è±Ô∏è" : "üê¢");

    s.score += points;
    if (App.settings.play==="teams") App.teams[tl.teamTurn].score += points;

    const reveal = tl.events.slice().sort((a,b)=>a.year-b.year).map(e => `‚Ä¢ ${e.year} ‚Äî ${e.title}`).join("\n");
    showModal("Timeline results", `
      <p class="muted">${escapeHtml(teamName)} scored <strong>${points}</strong> points (${correctPos}/${correct.length} positions correct) ‚Ä¢ ${speedTag}</p>
      <pre style="white-space:pre-wrap; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:10px;">${escapeHtml(reveal)}</pre>
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="tlNext">Next</button>
        <button class="btn" id="tlExit">Exit</button>
      </div>
    `);

    $("#tlExit").addEventListener("click", () => { closeModal(); setNav("home"); });
    $("#tlNext").addEventListener("click", () => {
      closeModal();
      if (App.settings.play==="teams") tl.teamTurn = (tl.teamTurn + 1) % App.teams.length;
      tl.round += 1;
      if (tl.round >= tl.rounds) { endSession(); return; }
      tl.events = pickTimelineSet().map(e=>({...e}));
      tl.order = tl.events.map(e=>e.id);
      tl.startedAt = Date.now();
      tl.submitted = false;
      renderTimeline();
      renderScoreStrip();
    });
  });

  renderScoreStrip();
}

/** ========= Buzz Bowl ========= */
function renderBuzzBowl(q) {
  const s = App.session;
  if (!s) return;
  ensureTeams(2);
  if (!s.buzz) s.buzz = { open:true, team:null, used: new Set() };

  $("#prompt").innerHTML = formatPrompt(q) + `<div class="mini" style="margin-top:10px;">üîî Buzz Bowl: first team to buzz answers. Wrong opens a steal.</div>`;

  const buzz = s.buzz;
  const teamButtons = App.teams.map((t, i) => {
    const locked = buzz.used.has(i);
    return `<button class="buzzBtn ${locked ? "locked":""}" data-buzz="${i}" ${locked ? "disabled":""}>${escapeHtml(t.name)} ${locked ? "‚úì tried":""}</button>`;
  }).join("");

  if (buzz.team === null) {
    $("#gameControls").innerHTML = `
      <div class="notice"><strong>Buzz in!</strong> Tap your team. You have 8 seconds to answer once you buzz.</div>
      <div class="buzzGrid">${teamButtons}</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="skipBtn">Skip</button>
      </div>
    `;
    $all("[data-buzz]").forEach(btn => btn.addEventListener("click", () => {
      const team = Number(btn.dataset.buzz);
      if (buzz.used.has(team)) return;
      buzz.team = team;
      buzz.open = false;
      clearTimeout(s._buzzTimer);
      s._buzzTimer = setTimeout(() => {
        if (!App.session || App.session.modeId !== "buzzbowl") return;
        if (App.session.buzz?.team === team) {
          App.session.buzz.team = null;
          App.session.buzz.open = true;
          App.session.buzz.used.add(team);
          toast("‚è±Ô∏è Buzz expired", `${App.teams[team]?.name || "Team"} lost the buzz.`);
          renderGame();
        }
      }, 8200);
      renderBuzzBowl(q);
    }));
    $("#skipBtn").addEventListener("click", () => {
      recordAttempt(q, false);
      showAfter("Skipped", `Correct: ${bestAnswerText(q)}.`, "bad");
    });
    return;
  }

  // Answer phase
  const blanks = (q.prompt.match(/_{3,}/g) || []).length;
  const teamName = teamLabel(buzz.team);

  $("#gameControls").innerHTML = `
    <div class="notice"><strong>${escapeHtml(teamName)}</strong> is answering (8s).</div>
    ${blanks<=1 ? `
      <div class="row">
        <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
        <button class="btn primary" id="submitBtn">Submit</button>
        <button class="btn" id="passBtn">Pass</button>
      </div>
    ` : `
      <div class="col">
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          ${Array.from({length: blanks}).map((_,i)=>`
            <input class="input multiAns" data-i="${i}" placeholder="Answer ${i+1}‚Ä¶" autocomplete="off" />
          `).join("")}
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="submitBtn">Submit</button>
          <button class="btn" id="passBtn">Pass</button>
        </div>
      </div>
    `}
  `;

  const submit = () => {
    let ua;
    if (blanks<=1) ua = $("#answerInput").value;
    else ua = Array.from(document.querySelectorAll(".multiAns")).map(i => i.value);
    handleAnswer(q, ua);
  };
  if (blanks<=1) { $("#answerInput").focus(); $("#answerInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); }); }
  $("#submitBtn").addEventListener("click", submit);
  $("#passBtn").addEventListener("click", () => {
    buzz.used.add(buzz.team);
    buzz.team = null;
    buzz.open = true;
    toast("Pass", "Buzz opened for a steal.");
    renderGame();
  });
}

/** ========= Relay Sprint ========= */
function advanceRelayTeam() {
  const s = App.session;
  if (!s || s.modeId !== "relay") return;
  ensureTeams(2);
  s.relay = s.relay || { team: 0, done: [] };
  s.relay.done.push(s.relay.team);
  const next = s.relay.team + 1;
  if (next >= App.teams.length) { endSession(); return; }

  showModal("Pass the device", `
    <p class="muted">Hand it to <strong>${teamLabel(next)}</strong>. They get 30 seconds.</p>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="relayReady">Ready</button>
      <button class="btn" id="relayExit">Exit</button>
    </div>
  `);
  $("#relayExit").addEventListener("click", () => { closeModal(); setNav("home"); });
  $("#relayReady").addEventListener("click", () => {
    closeModal();
    s.relay.team = next;
    s.teamIndex = next;
    s.timeLeft = 30;
    s.question = null;
    s.choices = null;
    startTimer();
    renderGame();
  });
}

function renderGame() {
  const s = App.session;
  if (!s) return;

  $("#gameModeBadge").textContent = s.title;
  $("#gameDeckBadge").textContent = (App.settings.deck === "core") ? "Core" : (App.settings.deck === "extended") ? "Extended" : "Both";
  $("#gameUnitBadge").textContent = selectedUnits().map(u => u.replace("unit","U")).join(" ");

  $("#afterControls").classList.add("hidden");
  $("#afterControls").innerHTML = "";

  if (s.modeId === "match") { renderMatch(); return; }
  if (s.modeId === "review") { renderReviewGuide(); return; }
  if (s.modeId === "flashcards") { renderFlashcards(); return; }
  if (s.modeId === "mystery") { renderMysteryGrid(); return; }
  if (s.modeId === "timeline") { renderTimeline(); return; }

  
  // Arcade modes (offline v11 imports)
  if (s.modeId === "conquest") { renderConquest(); return; }
  if (s.modeId === "jeopardy") { renderJeopardy(); return; }
  if (s.modeId === "boss") { renderBossBattle(); return; }
  if (s.modeId === "memory") { renderMemoryFlip(); return; }
  if (s.modeId === "chrono") { renderChronoStream(); return; }
  if (s.modeId === "wager") { renderWagerWheel(); return; }
  if (s.modeId === "type") { renderTypeSprint(); return; }
  if (s.modeId === "blitz") { renderNeonBlitz(); return; }
  if (s.modeId === "survival") { renderSurvival(); return; }

if (!s.question) {
    s.question = pickNextQuestion();
    if (!s.question) { endSession(); return; }
    s.used.add(s.question.id);

    // Per-question timer: start fresh when a new question appears.
    // (Streak + Relay are continuous timers managed elsewhere.)
    if (App.settings.timerOn && !["streak","relay"].includes(s.modeId)) {
      s.timeLeft = App.settings.timerSeconds;
      startTimer();
    } else if (!App.settings.timerOn) {
      stopTimer();
      $("#timerBadge").textContent = "‚è± Off";
    }
  }
  const q = s.question;


  // Survival needs custom timeout behavior (lose a life).
  s.onTimeUp = () => {
    if (!App.session || App.session.modeId !== "survival") return;
    recordAttempt(q, false);
    s.survival.lives -= 1;
    showAfter("Time‚Äôs up", `Life lost ‚Ä¢ Answer: ${bestAnswerText(q)}`, "bad");
    if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
    s.question = null;
    setTimeout(renderSurvival, App.settings.reduceMotion ? 150 : 420);
  };
  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">${escapeHtml(UNIT_META[q.unit] || q.unitName || q.unit)}</div>
      <span class="tag">${hasAutoAnswers(q) ? "Auto‚Äëgraded" : "Self‚Äëcheck"}</span>
    </div>
    <div style="margin-top:10px;">${formatPrompt(q)}</div>
    ${(App.settings.showHints && (q.hint || q.topic)) ? `<div class="muted" style="margin-top:10px;">Hint: ${escapeHtml(q.hint || q.topic)}</div>` : ""}
  `;

  if (s.modeId === "lightning") renderLightning(q);
  else if (s.modeId === "buzzbowl") renderBuzzBowl(q);
  else renderTyped(q);

  renderScoreStrip();
}

function renderTyped(q) {
  const blanks = (q.prompt.match(/_{3,}/g) || []).length;

  if (blanks <= 1) {
    $("#gameControls").innerHTML = `
      <div class="row">
        <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
        <button class="btn primary" id="submitBtn">Submit</button>
        <button class="btn" id="skipBtn">Skip</button>
      </div>
      <div class="mini" style="margin-top:10px;">Tip: spelling/spacing is flexible.</div>
    `;
    const input = $("#answerInput");
    input.focus();
    const submit = () => handleAnswer(q, input.value);
    $("#submitBtn").addEventListener("click", submit);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });
    $("#skipBtn").addEventListener("click", () => {
      recordAttempt(q, false);
      if (App.session?.modeId === "relay") {
      toast("‚è≠Ô∏è", `Correct: ${bestAnswerText(q)}`);
      App.session.question = null;
      renderGame();
      return;
    }
    if (App.session?.modeId === "streak") {
        App.session.streak = 0;
        toast("‚è≠Ô∏è", `Correct: ${bestAnswerText(q)}`);
        App.session.question = null;
        renderGame();
        return;
      }
      showAfter("Skipped", `Correct: ${bestAnswerText(q)}.`, "bad");
    });
    return;
  }

  // Multi-blank (2+)
  $("#gameControls").innerHTML = `
    <div class="col">
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        ${Array.from({length: blanks}).map((_,i)=>`
          <input class="input multiAns" data-i="${i}" placeholder="Answer ${i+1}‚Ä¶" autocomplete="off" />
        `).join("")}
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="submitBtn">Submit</button>
        <button class="btn" id="skipBtn">Skip</button>
      </div>
      <div class="mini" style="margin-top:10px;">Tip: enter each blank. Press Enter to move to the next box.</div>
    </div>
  `;
  const inputs = Array.from(document.querySelectorAll(".multiAns"));
  if (inputs[0]) inputs[0].focus();

  const submit = () => {
    const values = inputs.map(i => i.value);
    handleAnswer(q, values);
  };

  inputs.forEach((inp, idx) => {
    inp.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      if (idx < inputs.length - 1) inputs[idx+1].focus();
      else submit();
    });
  });

  $("#submitBtn").addEventListener("click", submit);
  $("#skipBtn").addEventListener("click", () => {
    recordAttempt(q, false);
    if (App.session?.modeId === "relay") {
      toast("‚è≠Ô∏è", `Correct: ${bestAnswerText(q)}`);
      App.session.question = null;
      renderGame();
      return;
    }
    if (App.session?.modeId === "streak") {
      App.session.streak = 0;
      toast("‚è≠Ô∏è", `Correct: ${bestAnswerText(q)}`);
      App.session.question = null;
      renderGame();
      return;
    }
    showAfter("Skipped", `Correct: ${bestAnswerText(q)}.`, "bad");
  });
}

function renderLightning(q) {
  const s = App.session;
  const pool = s.opts.customPool || s.pool;
  const accepted = (hasAutoAnswers(q) && !Array.isArray(q.acceptedAnswers[0])) ? q.acceptedAnswers[0] : null;
  if (!accepted) { renderTyped(q); return; }

    // Use smarter MC distractors (same unit + similar prompt/topic)
  const mc = buildMCOptionsFor(q, pool, 4);
  const options = mc ? mc.options : shuffle([accepted]); // (mc should almost always exist)
  s.choices = options;

  $("#gameControls").innerHTML = `
    <div class="choices">
      ${options.map((o,i)=>`<button class="choice" data-choice="${i}">${escapeHtml(o)}</button>`).join("")}
    </div>
    <div class="mini" style="margin-top:10px;">Fast points: more time left = more points.</div>
  `;
  $all("[data-choice]").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.dataset.choice);
      const pick = options[idx];
      const correct = normalize(pick) === normalize(accepted);
      $all("[data-choice]").forEach(b => {
        const val = options[Number(b.dataset.choice)];
        if (normalize(val) === normalize(accepted)) b.classList.add("correct");
        else if (b === btn && !correct) b.classList.add("wrong");
        b.disabled = true;
      });
      handleLightningResult(q, correct, accepted);
    });
  });
}

function handleLightningResult(q, correct, accepted) {
  const s = App.session;
  const base = 10;
  const bonus = App.settings.timerOn ? Math.floor((s.timeLeft / App.settings.timerSeconds) * 10) : 5;
  const gained = correct ? base + bonus : 0;

  recordAttempt(q, correct);
  if (correct) {
    s.score += gained;
    if (App.settings.play === "teams") App.teams[s.teamIndex].score += gained;
    beepSoft();
    showAfter("Correct ‚úÖ", `+${gained} points ‚Ä¢ Answer: ${accepted}`, "good");
  } else {
    showAfter("Not quite", `Answer: ${accepted}`, "bad");
  }
  if (App.settings.play === "teams") s.teamIndex = (s.teamIndex + 1) % App.teams.length;
  s.question = null;
  s.choices = null;
  // Timer restarts on the next question render (and only if enabled in Settings).
  setTimeout(renderGame, App.settings.reduceMotion ? 150 : 450);
}

function pointsFor(q, correct) {
  if (!correct) return 0;
  const s = App.session;
  let base = q.points || 10;
  if (s.modeId === "streak") base += Math.min(10, s.streak * 2);
  if (App.settings.timerOn && s.timeLeft != null && App.settings.timerSeconds) base += Math.floor((s.timeLeft / App.settings.timerSeconds) * 5);
  return base;
}

function showSelfCheck(q, typed) {
  const s = App.session;
  $("#gameControls").innerHTML = `
    <div class="row" style="align-items:flex-start;">
      <div style="flex:1;">
        <div class="muted">You typed:</div>
        <div style="font-weight:900; margin-top:4px;">${escapeHtml(Array.isArray(typed) ? typed.map(t=>t||"‚Äî").join(" / ") : (typed || "‚Äî"))}</div>
        <div class="mini" style="margin-top:10px;">No accepted answers yet. Mark it correct/incorrect.</div>
      </div>
      <div class="row">
        <button class="btn good" id="markCorrect">Mark correct</button>
        <button class="btn bad" id="markWrong">Mark wrong</button>
      </div>
    </div>
    <div class="mini" style="margin-top:10px;">Suggested: ${escapeHtml(bestAnswerText(q))}</div>
  `;
  $("#markCorrect").addEventListener("click", () => {
    recordAttempt(q, true);
    const gained = pointsFor(q, true);
    s.score += gained;
    if (App.settings.play === "teams") App.teams[s.teamIndex].score += gained;
    if (s.modeId === "streak") {
      s.streak += 1;
      s.bestStreak = Math.max(s.bestStreak, s.streak);
      toast(`‚úÖ +${gained} pts`, "Self-check marked correct");
      beepSoft();
      s.question = null;
      renderGame();
      return;
    }
    showAfter("Saved ‚úÖ", `+${gained} points`, "good");
  });
  $("#markWrong").addEventListener("click", () => {
    recordAttempt(q, false);
    if (s.modeId === "streak") {
      s.streak = 0;
      toast("‚ùå", "Self-check marked incorrect");
      s.question = null;
      renderGame();
      return;
    }
    showAfter("Saved", "Marked incorrect.", "bad");
  });
}

function showAfter(title, msg, tone) {
  const s = App.session;
  if (s && !["streak","relay"].includes(s.modeId)) {
    stopTimer();
    if (!App.settings.timerOn) $("#timerBadge").textContent = "‚è± Off";
  }
  const box = $("#afterControls");
  box.classList.remove("hidden");
  const toneColor = (tone==="good") ? "rgba(134,239,172,.12)" : (tone==="bad") ? "rgba(253,164,175,.12)" : "rgba(255,255,255,.06)";
  box.innerHTML = `
    <div class="card" style="padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:${toneColor};">
      <div style="font-weight:950;">${escapeHtml(title)}</div>
      <div class="muted" style="margin-top:4px;">${escapeHtml(msg)}</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="nextBtn">Next</button>
        <button class="btn" id="replayBtn">Replay</button>
      </div>
    </div>
  `;
  $("#nextBtn").addEventListener("click", () => {
    const s = App.session;
    if (!s) return;
    if (App.settings.play === "teams") {
      if (s.modeId === "sudden" && s.aliveTeams) s.teamIndex = nextAliveIndex(s.aliveTeams, s.teamIndex);
      else s.teamIndex = (s.teamIndex + 1) % App.teams.length;
    }
    s.question = null;
    s.choices = null;
    renderGame();
  });
  $("#replayBtn").addEventListener("click", () => {
    const s = App.session;
    if (!s) return;
    s.used.delete(s.question.id);
    s.question = null;
    s.choices = null;
    renderGame();
  });
}

function handleAnswer(q, userAnswer) {
  const s = App.session;

  // Buzz Bowl
  if (s?.modeId === "buzzbowl") {
    const verdict = isCorrect(q, userAnswer);
    if (verdict === null) { showSelfCheck(q, userAnswer); return; }

    const team = s.buzz?.team;
    if (team == null) { toast("Buzz first", "A team must buzz in before answering."); return; }

    recordAttempt(q, verdict);

    if (verdict) {
      const gained = 10;
      s.score += gained;
      if (App.settings.play==="teams") App.teams[team].score += gained;
      beepSoft();
      showAfter("Correct ‚úÖ", `${teamLabel(team)} +${gained} ‚Ä¢ ${bestAnswerText(q)}`, "good");
      s.buzz = { open:true, team:null, used:new Set() };
      return;
    }

    // Wrong: open steal
    s.buzz.used.add(team);
    s.buzz.team = null;
    s.buzz.open = true;
    toast("Wrong ‚Äî steal open", `Correct: ${bestAnswerText(q)}`);
    renderGame();
    return;
  }

  // Sudden Death
  if (s?.modeId === "sudden" && App.settings.play === "teams") {
    const verdict = isCorrect(q, userAnswer);
    if (verdict === null) { showSelfCheck(q, userAnswer); return; }
    recordAttempt(q, verdict);

    if (verdict) {
      const gained = 10;
      s.score += gained;
      App.teams[s.teamIndex].score += gained;
      beepSoft();
      showAfter("Correct ‚úÖ", `${teamLabel(s.teamIndex)} survives ‚Ä¢ +${gained} ‚Ä¢ ${bestAnswerText(q)}`, "good");
      return;
    }

    if (!s.aliveTeams) s.aliveTeams = App.teams.map(()=>true);
    s.aliveTeams[s.teamIndex] = false;

    const alive = aliveCount(s.aliveTeams);
    if (alive <= 1) {
      showAfter("Eliminated üíÄ", `Correct: ${bestAnswerText(q)}. ${teamLabel(s.teamIndex)} is out.`, "bad");
      setTimeout(endSession, 450);
      return;
    }
    showAfter("Eliminated üíÄ", `Correct: ${bestAnswerText(q)}. ${teamLabel(s.teamIndex)} is out.`, "bad");
    return;
  }

  // Relay Sprint
  if (s?.modeId === "relay" && App.settings.play === "teams") {
    const verdict = isCorrect(q, userAnswer);
    if (verdict === null) { showSelfCheck(q, userAnswer); return; }
    recordAttempt(q, verdict);

    if (verdict) {
      const gained = pointsFor(q, true);
      s.score += gained;
      App.teams[s.teamIndex].score += gained;
      beepSoft();
      toast("‚úÖ", `${teamLabel(s.teamIndex)} +${gained}`);
    } else {
      toast("‚ùå", `Correct: ${bestAnswerText(q)}`);
    }
    s.question = null;
    s.choices = null;
    renderGame();
    return;
  }

  // Default behavior
  const verdict = isCorrect(q, userAnswer);
  if (verdict === null) { showSelfCheck(q, userAnswer); return; }
  recordAttempt(q, verdict);

  // Streak Sprint: rapid-fire
  if (s.modeId === "streak") {
    if (verdict) {
      s.streak += 1;
      s.bestStreak = Math.max(s.bestStreak, s.streak);
      const gained = pointsFor(q, true);
      s.score += gained;
      beepSoft();
      toast("‚úÖ", `+${gained} ‚Ä¢ Streak ${s.streak}`);
      s.question = null;
      renderGame();
      return;
    }
    s.streak = 0;
    toast("‚ùå", `Correct: ${bestAnswerText(q)}`);
    s.question = null;
    renderGame();
    return;
  }

  if (verdict) {
    const gained = pointsFor(q, true);
    s.score += gained;
    if (App.settings.play === "teams") App.teams[s.teamIndex].score += gained;
    beepSoft();
    showAfter("Correct ‚úÖ", `+${gained} points ‚Ä¢ ${bestAnswerText(q)}`, "good");
    return;
  }

  // Wrong
  showAfter("Not quite", `Correct: ${bestAnswerText(q)}`, "bad");

  // Team Showdown steal
  if (App.settings.play === "teams" && (s.opts?.label === "Team Showdown")) {
    const stealTeam = (s.teamIndex + 1) % App.teams.length;
    const box = $("#afterControls");
    box.classList.remove("hidden");
    box.innerHTML = `
      <div class="card" style="padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(253,164,175,.10);">
        <div style="font-weight:950;">Steal attempt?</div>
        <div class="muted" style="margin-top:4px;">${escapeHtml(App.teams[stealTeam].name)} can steal for 8 points.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="stealYes">Steal</button>
          <button class="btn" id="stealNo">No steal</button>
        </div>
      </div>
    `;
    $("#stealYes").addEventListener("click", () => {
      s.teamIndex = stealTeam;
      $("#gameControls").innerHTML = `
        <div class="row">
          <input id="answerInput" class="input" placeholder="Steal answer‚Ä¶" autocomplete="off" />
          <button class="btn primary" id="submitBtn">Submit</button>
        </div>
      `;
      const input = $("#answerInput");
      input.focus();
      const submit = () => {
        const v = isCorrect(q, input.value);
        if (v) {
          const gained = 8;
          s.score += gained;
          App.teams[stealTeam].score += gained;
          beepSoft();
          showAfter("Steal ‚úÖ", `+${gained} points ‚Ä¢ ${bestAnswerText(q)}`, "good");
        } else {
          showAfter("No steal", `Correct: ${bestAnswerText(q)}`, "bad");
        }
      };
      $("#submitBtn").addEventListener("click", submit);
      input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); });
    });
    $("#stealNo").addEventListener("click", () => toast("No steal", "Moving on."));
  }
}

 /** ========= Flashcards ========= */
function renderFlashcards() {
  const s = App.session;
  stopTimer();
  $("#timerBadge").textContent = "‚è± Off";

  const pool = (s.opts.customPool || s.pool);
  const scored = pool.map(q => {
    const box = App.leitner[q.id] || 1;
    const p = App.progress[q.id] || {attempts:0, correct:0};
    const acc = p.attempts ? (p.correct/p.attempts) : 0.5;
    return {q, box, acc};
  }).sort((a,b)=> (a.box-b.box) || (a.acc-b.acc));

  const item = scored[0]?.q;
  if (!item) { endSession(); return; }
  s.question = item;

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">Flashcard ‚Ä¢ ${escapeHtml(UNIT_META[item.unit] || item.unit)}</div>
      <span class="tag">Box ${App.leitner[item.id] || 1}</span>
    </div>
    <div style="margin-top:10px;">${formatPrompt(item)}</div>
    <div class="muted" style="margin-top:10px;">Tap ‚ÄúReveal‚Äù, then rate yourself.</div>
  `;

  $("#gameControls").innerHTML = `
    <div class="row">
      <button class="btn primary" id="revealBtn">Reveal</button>
      <button class="btn" id="skipCard">Skip</button>
    </div>
  `;
  $("#afterControls").classList.add("hidden");
  $("#afterControls").innerHTML = "";

  $("#revealBtn").addEventListener("click", () => {
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `
      <div class="card" style="padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12);">
        <div style="font-weight:950;">Answer</div>
        <div class="muted" style="margin-top:4px;">${escapeHtml(bestAnswerText(item))}</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn bad" data-rate="again">Again</button>
          <button class="btn" data-rate="hard">Hard</button>
          <button class="btn good" data-rate="good">Good</button>
          <button class="btn primary" data-rate="easy">Easy</button>
        </div>
      </div>
    `;
    $all("[data-rate]").forEach(b => {
      b.addEventListener("click", () => {
        const r = b.dataset.rate;
        const box = App.leitner[item.id] || 1;
        let next = box;
        if (r === "again") next = 1;
        if (r === "hard") next = clamp(box, 1, 4);
        if (r === "good") next = clamp(box+1, 1, 4);
        if (r === "easy") next = clamp(box+2, 1, 4);
        App.leitner[item.id] = next;
        recordAttempt(item, r!=="again");
        s.score += (r==="easy") ? 12 : (r==="good") ? 10 : (r==="hard") ? 7 : 0;
        s.question = null;
        persist();
        renderGame();
      });
    });
  });
  $("#skipCard").addEventListener("click", () => { s.question = null; renderGame(); });

  renderScoreStrip();
}

/** ========= Match-Up ========= */
function renderMatch() {
  const s = App.session;
  stopTimer();
  $("#timerBadge").textContent = "‚è± Off";

  const pool = (s.opts.customPool || s.pool).filter(q => hasAutoAnswers(q) && !Array.isArray(q.acceptedAnswers[0]));
  const pairs = sample(pool, 6).map(q => ({ id: q.id, term: q.acceptedAnswers[0], def: q.prompt.replace(/_{5,}/g, "_____"), unit: q.unit }));
  if (pairs.length < 4) {
    $("#prompt").innerHTML = `<div class="muted">Not enough auto-graded questions for Match‚ÄëUp. Turn on Core deck or more units.</div>`;
    $("#gameControls").innerHTML = `<button class="btn primary" id="backHome">Back</button>`;
    $("#backHome").addEventListener("click", ()=>setNav("home"));
    return;
  }

  const terms = shuffle(pairs.map(p => ({ key: "t-"+p.id, kind:"term", text:p.term, match:p.id })));
  const defs  = shuffle(pairs.map(p => ({ key: "d-"+p.id, kind:"def",  text:p.def,  match:p.id })));
  const cards = [...terms, ...defs];

  s.matchState = { cards, picked: [], matched: new Set(), moves: 0 };

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">Match‚ÄëUp</div>
      <span class="tag">Match terms ‚Üî definitions</span>
    </div>
    <div class="muted" style="margin-top:10px;">Tap two cards. If they match, they stay revealed.</div>
  `;

  const renderBoard = () => {
    const ms = s.matchState;
    $("#gameControls").innerHTML = `
      <div class="choices" style="grid-template-columns: repeat(2, minmax(0,1fr));">
        ${ms.cards.map(c => {
          const isPicked = ms.picked.includes(c.key);
          const isMatched = ms.matched.has(c.match);
          const show = isPicked || isMatched;
          const label = show ? escapeHtml(c.text) : "‚Ä¢ ‚Ä¢ ‚Ä¢";
          const style = isMatched ? "opacity:.6;" : "";
          return `<button class="choice" style="${style}" data-mcard="${escapeHtml(c.key)}">${label}</button>`;
        }).join("")}
      </div>
      <div class="row" style="margin-top:12px;">
        <span class="badge">Moves: ${ms.moves}</span>
        <span class="badge">Matched: ${ms.matched.size}/${pairs.length}</span>
        <button class="btn" id="reshuffle">Reshuffle</button>
      </div>
    `;
    $all("[data-mcard]").forEach(btn => btn.addEventListener("click", () => onPick(btn.dataset.mcard)));
    $("#reshuffle").addEventListener("click", () => { ms.cards = shuffle(ms.cards); ms.picked = []; renderBoard(); });
    renderScoreStrip();
  };

  const onPick = (key) => {
    const ms = s.matchState;
    const card = ms.cards.find(c => c.key === key);
    if (!card) return;
    if (ms.matched.has(card.match)) return;
    if (ms.picked.includes(key)) return;
    if (ms.picked.length >= 2) return;

    ms.picked.push(key);
    if (ms.picked.length === 2) {
      ms.moves += 1;
      const a = ms.cards.find(c => c.key === ms.picked[0]);
      const b = ms.cards.find(c => c.key === ms.picked[1]);
      const match = a && b && a.match === b.match && a.kind !== b.kind;
      if (match) {
        ms.matched.add(a.match);
        s.score += 10;
        if (App.settings.play==="teams") App.teams[s.teamIndex].score += 10;
        beepSoft();
        ms.picked = [];
        if (ms.matched.size === pairs.length) endSession();
      } else {
        setTimeout(() => { ms.picked = []; renderBoard(); }, App.settings.reduceMotion ? 150 : 650);
        return;
      }
    }
    renderBoard();
  };

  renderBoard();
}

/** ========= Mystery Grid ========= */
function renderMysteryGrid() {
  const s = App.session;
  stopTimer();
  $("#timerBadge").textContent = "‚è± Off";

  const pool = s.opts.customPool || s.pool;
  const units = selectedUnits();
  const tiles = Array.from({length:16}, (_,i)=>({
    key: "tile-"+i,
    unit: units[i % units.length],
    label: (UNIT_META[units[i % units.length]]||"Unit").split("‚Ä¢")[0].trim(),
    used: false
  }));
  s.tiles = tiles;

  const renderTiles = () => {
    $("#prompt").innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:900;">Mystery Grid</div>
        <span class="tag">${escapeHtml(App.settings.play==="teams" ? "Teams" : "Solo")}</span>
      </div>
      <div class="muted" style="margin-top:10px;">Pick a tile to reveal a question. Mark it correct/incorrect.</div>
    `;
    $("#gameControls").innerHTML = `
      <div class="gridTiles">
        ${tiles.map(t => `
          <div class="tile ${t.used ? "used" : ""}" data-tile="${t.key}">
            <div class="tTitle">${escapeHtml(t.label)}</div>
            <div class="tMeta">${escapeHtml(t.used ? "Used" : "Tap to reveal")}</div>
          </div>
        `).join("")}
      </div>
      <div class="row" style="padding:0 14px 14px;">
        <button class="btn" id="gridReset">New grid</button>
        <button class="btn primary" id="gridEnd">End session</button>
      </div>
    `;
    $all("[data-tile]").forEach(el => {
      el.addEventListener("click", () => {
        const tile = tiles.find(t => t.key === el.dataset.tile);
        if (!tile || tile.used) return;
        tile.used = true;
        const unitQs = pool.filter(q => q.unit === tile.unit);
        const pick = unitQs.find(q => !s.used.has(q.id)) || unitQs[0];
        if (!pick) return;
        s.used.add(pick.id);
        showModal("Tile question", `
          <div style="font-weight:900; margin-bottom:8px;">${escapeHtml(UNIT_META[pick.unit] || pick.unitName || pick.unit)}</div>
          <div style="line-height:1.35;">${formatPrompt(pick)}</div>
          <div class="row" style="margin-top:12px;">
            <button class="btn good" id="tileCorrect">Correct</button>
            <button class="btn bad" id="tileWrong">Incorrect</button>
          </div>
          <div class="mini" style="margin-top:10px;">Answer: ${escapeHtml(bestAnswerText(pick))}</div>
        `);
        $("#tileCorrect").addEventListener("click", () => {
          recordAttempt(pick, true);
          s.score += 10;
          if (App.settings.play==="teams") { App.teams[s.teamIndex].score += 10; s.teamIndex = (s.teamIndex+1)%App.teams.length; }
          closeModal(); renderTiles(); renderScoreStrip();
        });
        $("#tileWrong").addEventListener("click", () => {
          recordAttempt(pick, false);
          if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
          closeModal(); renderTiles(); renderScoreStrip();
        });
      });
    });
    $("#gridReset").addEventListener("click", () => startMode("mystery"));
    $("#gridEnd").addEventListener("click", endSession);
    renderScoreStrip();
  };
  renderTiles();
}

/** ========= End session ========= */
function endSession() {
  stopTimer();
  const s = App.session;
  const finalScore = s?.score || 0;
  const teamScores = (App.settings.play==="teams") ? App.teams.map(t => `${t.name}: ${t.score}`).join(" ‚Ä¢ ") : null;
  showModal("Session complete", `
    <p class="muted">Play again, switch units, or try a different mode.</p>
    <div class="kpi">
      <div class="chip"><strong>${finalScore}</strong> points</div>
      ${teamScores ? `<div class="chip"><strong>${escapeHtml(teamScores)}</strong></div>` : ""}
      <div class="chip"><strong>${App.mistakes.length}</strong> in mistake bank</div>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="playAgain">Play again</button>
      <button class="btn" id="goHome">Home</button>
    </div>
  `);
  $("#playAgain").addEventListener("click", () => { closeModal(); startMode(s.modeId, s.opts || {}); });
  $("#goHome").addEventListener("click", () => { closeModal(); setNav("home"); });
}

/** ========= Toast ========= */
$("#toastClose").addEventListener("click", toastHide);
setInterval(() => { if (!$("#toast").classList.contains("hidden") && !$("#modal").classList.contains("show")) toastHide(); }, 4200);

/** ========= Showdown shortcut ========= */
document.querySelectorAll('[data-start="showdown"]').forEach(btn => {
  btn.addEventListener("click", () => {
    App.settings.play = "teams";
    persist();
    syncHomeControls();
    startMode("quick", { label: "Team Showdown" });
  });
});

/** ========= Boot ========= */


function currentPool(){
  const decks = (App.settings.deck === "core") ? DEFAULT_DECKS.core
              : (App.settings.deck === "extended") ? DEFAULT_DECKS.extended
              : DEFAULT_DECKS.core.concat(DEFAULT_DECKS.extended);
  const units = selectedUnits();
  return decks.filter(q => units.includes(q.unit));
}

/** =======================
 * Arcade Modes (ported from offline v11 concepts)
 * - Uses fix_v5 question pool + settings
 * - Adds safe overlay + mode-specific timers
 * ======================= */

function ensureScanlines() {
  if ($("#scanlines")) return;
  const d = document.createElement("div");
  d.id = "scanlines";
  document.body.appendChild(d);
}
function ensureStars() {
  if ($("#stars")) return;
  const wrap = document.createElement("div");
  wrap.id = "stars";
  wrap.setAttribute("aria-hidden", "true");
  const count = 42; // light starfield like the reference arcade lobby
  for (let i = 0; i < count; i++) {
    const s = document.createElement("div");
    s.className = "star";
    s.style.top = (Math.random() * 100).toFixed(2) + "%";
    s.style.left = (Math.random() * 100).toFixed(2) + "%";
    s.style.opacity = (0.15 + Math.random() * 0.85).toFixed(2);
    s.style.setProperty("--tw", (2 + Math.random() * 4).toFixed(2) + "s");
    s.style.setProperty("--d", (-Math.random() * 4).toFixed(2) + "s");
    s.style.setProperty("--s", (0.6 + Math.random() * 1.4).toFixed(2));
    wrap.appendChild(s);
  }
  document.body.appendChild(wrap);
}


function ensureGameOverlay() {
  let el = $("#gameOverlay");
  if (el) return el;
  el = document.createElement("div");
  el.id = "gameOverlay";
  el.className = "gameOverlay hidden";
  el.innerHTML = `<div class="overlayCard neon-box">
      <div class="overlayTop">
        <div class="title font-tech" id="overlayTitle">Challenge</div>
        <button class="overlayClose" id="overlayCloseBtn">Close</button>
      </div>
      <div id="overlayBody"></div>
    </div>`;
  document.body.appendChild(el);
  $("#overlayCloseBtn").addEventListener("click", () => closeGameOverlay());
  el.addEventListener("click", (e) => { if (e.target === el) closeGameOverlay(); });
  return el;
}

function openGameOverlay(title, html, opts={}) {
  ensureGameOverlay();
  $("#overlayTitle").textContent = title || "Challenge";
  $("#overlayBody").innerHTML = html || "";
  $("#gameOverlay").classList.remove("hidden");

  // hook close
  App.session._overlayOnClose = opts.onClose || null;

  // start timer for overlay questions if requested
  if (opts.startTimer) {
    const s = App.session;
    s.timeLeft = (typeof opts.seconds === "number") ? opts.seconds : App.settings.timerSeconds;
    // Provide mode-specific onTimeUp handler
    s.onTimeUp = opts.onTimeUp || null;
    startTimer();
  } else {
    // Ensure no accidental timer carryover
    if (App.session) App.session.onTimeUp = null;
  }
}

function closeGameOverlay() {
  const s = App.session;
  $("#gameOverlay")?.classList.add("hidden");
  // stop timer and clear handler
  stopTimer();
  if (s) s.onTimeUp = null;
  const cb = s?._overlayOnClose;
  if (s) s._overlayOnClose = null;
  if (typeof cb === "function") { try { cb(); } catch(e){} }
}
/** ---- Shared: build 4-option MC for a question when possible ----
 *  Smarter distractors:
 *  - stays inside the review guide (your pool)
 *  - prefers SAME UNIT
 *  - prefers similar prompt vocabulary (same ‚Äútopic lane‚Äù)
 *  - prefers answers with similar ‚Äúshape‚Äù (word count / suffix)
 */
function buildMCOptionsFor(q, pool, n=4) {

  // Only for single-blank-ish auto answers
  if (!hasAutoAnswers(q)) return null;
  if (Array.isArray(q.acceptedAnswers?.[0])) return null; // multi blank => typed

  const accepted = q.acceptedAnswers[0];
  const accN = normalize(accepted);

  const STOP = new Set([
    "the","a","an","of","and","or","to","in","on","for","with","from","by","as","at","into",
    "between","after","before","during","under","over","across","throughout","their","his","her",
    "was","were","is","are","be","been","being","called","known","named","term","which","that",
    "this","these","those","it","its","they","them","every","each","basic","system","process"
  ]);

  const tokens = (text) => String(text || "")
    .toLowerCase()
    .replace(/[_‚Äî‚Äì-]/g, " ")
    .replace(/[^a-z0-9\s]/g, " ")
    .split(/\s+/)
    .filter(w => w && w.length > 2 && !STOP.has(w));

  const wordCount = (s) => String(s || "").trim().split(/\s+/).filter(Boolean).length;

  const suffix4 = (s) => {
    const t = normalize(String(s || ""));
    return t.length >= 7 ? t.slice(-4) : t;
  };

  const dedupeNorm = (arr) => {
    const out = [];
    const seen = new Set();
    for (const v of arr) {
      const k = normalize(v);
      if (!k || seen.has(k)) continue;
      seen.add(k);
      out.push(v);
    }
    return out;
  };

  const isSingleAuto = (x) => hasAutoAnswers(x) && !Array.isArray(x.acceptedAnswers?.[0]);

  const sameUnitQs = pool.filter(x => x.unit === q.unit && isSingleAuto(x));
  const allQs     = pool.filter(x => isSingleAuto(x));

  const buildCandidates = (qs) => qs
    .map(x => ({ ans: x.acceptedAnswers[0], prompt: x.prompt || "" }))
    .filter(o => normalize(o.ans) !== accN);

  let cands = buildCandidates(sameUnitQs);
  if (cands.length < (n - 1)) cands = buildCandidates(allQs);
  if (!cands.length) return null;

  const qTok = tokens(q.prompt || "");
  const qSet = new Set(qTok);

  const accWC = wordCount(accepted);
  const accSuf = suffix4(accepted);
  const accFirst = accN[0] || "";

  const ranked = cands.map(c => {
    const cTok = tokens(c.prompt);
    const cSet = new Set(cTok);

    let overlap = 0;
    qSet.forEach(t => { if (cSet.has(t)) overlap++; });

    const wcDiff = Math.abs(wordCount(c.ans) - accWC);
    const lenDiff = Math.abs(String(c.ans).length - String(accepted).length);

    let score = overlap * 4;
    if (wcDiff === 0) score += 3;
    else if (wcDiff === 1) score += 1;
    else score -= 1;

    if (suffix4(c.ans) === accSuf) score += 2;
    if ((normalize(c.ans)[0] || "") === accFirst) score += 0.5;

    score -= lenDiff * 0.05;

    return { ...c, score };
  }).sort((a,b) => b.score - a.score);

  const topBucket = ranked.slice(0, Math.max(12, (n - 1) * 6));
  let pickPool = dedupeNorm(topBucket.map(r => r.ans)).filter(a => normalize(a) !== accN);

  let distractors = sample(pickPool, n - 1);

  if (distractors.length < (n - 1)) {
    const fallbackPool = dedupeNorm(ranked.map(r => r.ans))
      .filter(a => normalize(a) !== accN)
      .filter(a => !distractors.some(d => normalize(d) === normalize(a)));

    distractors = distractors.concat(sample(fallbackPool, (n - 1) - distractors.length));
  }

  if (distractors.length < (n - 1)) return null;

  const options = shuffle([accepted, ...distractors]).slice(0, n);
  return { accepted, options };
}

function overlayAskQuestion(q, title, opts={}) {
  const s = App.session;
  const pool = s.opts.customPool || s.pool;

  // Try MC first for snappy arcade feel
  const mc = buildMCOptionsFor(q, pool, 4);
  let html = "";
  if (mc) {
    html = `
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div class="badge">${escapeHtml(UNIT_META[q.unit] || q.unitName || q.unit)}</div>
        <div class="badge">‚è± ${App.settings.timerOn ? (opts.seconds ?? App.settings.timerSeconds) + "s" : "Off"}</div>
      </div>
      <div style="font-weight:900; font-size:18px; line-height:1.25; margin-bottom:12px;">${formatPrompt(q)}</div>
      <div class="choices">
        ${mc.options.map((o,i)=>`<button class="choice" data-ovchoice="${i}">${escapeHtml(o)}</button>`).join("")}
      </div>
      <div class="mini" style="margin-top:10px;">Pick fast. Timer counts!</div>
    `;
    openGameOverlay(title, html, {
      startTimer: App.settings.timerOn,
      seconds: opts.seconds ?? App.settings.timerSeconds,
      onTimeUp: () => {
        // time up counts wrong
        if (!App.session) return;
        recordAttempt(q, false);
        closeGameOverlay();
        (opts.onResult||(()=>{}))(false, mc.accepted, "timeout");
      },
      onClose: () => {
        // If player closes without answering, treat as wrong if required
        if (opts.closeIsWrong) {
          recordAttempt(q, false);
          (opts.onResult||(()=>{}))(false, mc.accepted, "closed");
        }
      }
    });

    $all("[data-ovchoice]").forEach(btn => {
      btn.addEventListener("click", () => {
        const pick = mc.options[Number(btn.dataset.ovchoice)];
        const correct = normalize(pick) === normalize(mc.accepted);
        // reveal
        $all("[data-ovchoice]").forEach(b => {
          const val = mc.options[Number(b.dataset.ovchoice)];
          if (normalize(val) === normalize(mc.accepted)) b.classList.add("correct");
          else if (b === btn && !correct) b.classList.add("wrong");
          b.disabled = true;
        });
        stopTimer();
        recordAttempt(q, correct);
        setTimeout(() => {
          closeGameOverlay();
          (opts.onResult||(()=>{}))(correct, mc.accepted, "answered");
        }, App.settings.reduceMotion ? 150 : 420);
      });
    });

    return { kind:"mc", accepted: mc.accepted };
  }

  // fallback typed
  html = `
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <div class="badge">${escapeHtml(UNIT_META[q.unit] || q.unitName || q.unit)}</div>
      <div class="badge">‚è± ${App.settings.timerOn ? (opts.seconds ?? App.settings.timerSeconds) + "s" : "Off"}</div>
    </div>
    <div style="font-weight:900; font-size:18px; line-height:1.25; margin-bottom:12px;">${formatPrompt(q)}</div>
    <div class="row">
      <input id="ovAnswerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
      <button class="btn primary" id="ovSubmitBtn">Submit</button>
    </div>
    <div class="mini" style="margin-top:10px;">Spelling/spacing is flexible.</div>
  `;
  openGameOverlay(title, html, {
    startTimer: App.settings.timerOn,
    seconds: opts.seconds ?? App.settings.timerSeconds,
    onTimeUp: () => {
      if (!App.session) return;
      recordAttempt(q, false);
      closeGameOverlay();
      (opts.onResult||(()=>{}))(false, bestAnswerText(q), "timeout");
    },
    onClose: () => {
      if (opts.closeIsWrong) {
        recordAttempt(q, false);
        (opts.onResult||(()=>{}))(false, bestAnswerText(q), "closed");
      }
    }
  });

  const inp = $("#ovAnswerInput");
  inp?.focus();
  const submit = () => {
    const v = isCorrect(q, inp?.value || "");
    if (v === null) {
      // self-check UI inside overlay
      stopTimer();
      $("#overlayBody").insertAdjacentHTML("beforeend", `
        <div class="notice" style="margin-top:12px;">
          Self-check: Correct answer: <strong>${escapeHtml(bestAnswerText(q))}</strong>
          <div class="row" style="margin-top:10px;">
            <button class="btn good" id="ovMarkCorrect">I was correct</button>
            <button class="btn bad" id="ovMarkWrong">I was wrong</button>
          </div>
        </div>
      `);
      $("#ovSubmitBtn").disabled = true;
      inp.disabled = true;
      $("#ovMarkCorrect").addEventListener("click", () => {
        recordAttempt(q, true);
        closeGameOverlay();
        (opts.onResult||(()=>{}))(true, bestAnswerText(q), "self");
      });
      $("#ovMarkWrong").addEventListener("click", () => {
        recordAttempt(q, false);
        closeGameOverlay();
        (opts.onResult||(()=>{}))(false, bestAnswerText(q), "self");
      });
      return;
    }
    stopTimer();
    recordAttempt(q, v);
    closeGameOverlay();
    (opts.onResult||(()=>{}))(v, bestAnswerText(q), "answered");
  };
  $("#ovSubmitBtn").addEventListener("click", submit);
  inp?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") submit(); });

  return { kind:"typed" };
}

/** =======================
 * Mode: Neon Blitz (10 Q speed run)
 * ======================= */
function renderNeonBlitz() {
  const s = App.session;
  const pool = s.opts.customPool || s.pool;
  if (!s.blitz) s.blitz = { remaining: 10, correct: 0 };

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">NEON BLITZ</div>
      <div class="tag">Remaining: ${s.blitz.remaining}</div>
    </div>
    <div class="mini" style="margin-top:8px;">10 questions. Fast answers score more.</div>
  `;

  if (s.blitz.remaining <= 0) {
    showAfter("Blitz complete", `Correct: ${s.blitz.correct}/10 ‚Ä¢ Score: ${s.score}`, "good");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="blitzAgain">Play again</button>
      <button class="btn" id="blitzExit">Exit</button>
    </div>`;
    $("#blitzAgain").addEventListener("click", () => startMode("blitz"));
    $("#blitzExit").addEventListener("click", endSession);
    return;
  }

  // draw next q (not using global s.question loop)
  const q = pickNextQuestion();
  if (!q) { endSession(); return; }
  s.used.add(q.id);

  // per question timer
  if (App.settings.timerOn) { 
    s.timeLeft = App.settings.timerSeconds; 
    startTimer(); 
  } else { 
    stopTimer(); 
    $("#timerBadge").textContent = "‚è± Off"; 
  }
  // If time runs out in Blitz, count it as wrong and move on.
  s.onTimeUp = () => {
    if (!App.session || App.session.modeId !== "blitz") return;
    recordAttempt(q, false);
    showAfter("Time‚Äôs up", `Answer: ${bestAnswerText(q)}`, "bad");
    if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
    s.blitz.remaining -= 1;
    s.question = null;
    setTimeout(renderNeonBlitz, App.settings.reduceMotion ? 150 : 420);
  };

  // MC when possible else typed
  const mc = buildMCOptionsFor(q, pool, 4);
  $("#prompt").insertAdjacentHTML("beforeend", `<div style="margin-top:10px;">${formatPrompt(q)}</div>`);
  if (mc) {
    $("#gameControls").innerHTML = `
      <div class="choices">
        ${mc.options.map((o,i)=>`<button class="choice" data-bchoice="${i}">${escapeHtml(o)}</button>`).join("")}
      </div>
      <div class="mini" style="margin-top:10px;">Bonus scales with time left.</div>
    `;
    $all("[data-bchoice]").forEach(btn => {
      btn.addEventListener("click", () => {
        const pick = mc.options[Number(btn.dataset.bchoice)];
        const correct = normalize(pick) === normalize(mc.accepted);
        stopTimer();
        recordAttempt(q, correct);
        if (correct) {
          s.blitz.correct += 1;
          const base = 12;
          const bonus = App.settings.timerOn ? Math.floor((s.timeLeft / App.settings.timerSeconds) * 10) : 5;
          const gained = base + bonus;
          s.score += gained;
          if (App.settings.play==="teams") App.teams[s.teamIndex].score += gained;
          beepSoft();
          showAfter("‚úÖ Hit!", `+${gained} ‚Ä¢ ${mc.accepted}`, "good");
        } else {
          showAfter("‚ùå Miss", `Answer: ${mc.accepted}`, "bad");
        }
        if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
        s.blitz.remaining -= 1;
        setTimeout(renderNeonBlitz, App.settings.reduceMotion ? 150 : 420);
      });
    });
  } else {
    // typed fallback
    $("#gameControls").innerHTML = `
      <div class="row">
        <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
        <button class="btn primary" id="submitBtn">Submit</button>
        <button class="btn" id="skipBtn">Skip</button>
      </div>
    `;
    const input = $("#answerInput"); input.focus();
    const submit = () => {
      const v = isCorrect(q, input.value);
      if (v === null) { showSelfCheck(q, input.value); return; }
      stopTimer();
      recordAttempt(q, v);
      if (v) {
        s.blitz.correct += 1;
        const gained = 12;
        s.score += gained;
        if (App.settings.play==="teams") App.teams[s.teamIndex].score += gained;
        beepSoft();
        showAfter("‚úÖ", `+${gained} ‚Ä¢ ${bestAnswerText(q)}`, "good");
      } else {
        showAfter("‚ùå", `Answer: ${bestAnswerText(q)}`, "bad");
      }
      if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
      s.blitz.remaining -= 1;
      s.question = null;
      setTimeout(renderNeonBlitz, App.settings.reduceMotion ? 150 : 420);
    };
    $("#submitBtn").addEventListener("click", submit);
    input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); });
    $("#skipBtn").addEventListener("click", () => { stopTimer(); recordAttempt(q,false); s.blitz.remaining -= 1; showAfter("Skipped", `Answer: ${bestAnswerText(q)}`, "bad"); setTimeout(renderNeonBlitz, 250); });
  }

  renderScoreStrip();
}

/** =======================
 * Mode: Type-It Sprint (60s continuous)
 * ======================= */
function renderTypeSprint() {
  const s = App.session;
  if (!s.typeSprint) s.typeSprint = { correct: 0, wrong: 0 };

  // continuous timer
  if (App.settings.timerOn) {
    if (!s.timer) { s.timeLeft = 60; startTimer();
      // End sprint cleanly on timeout
      s.onTimeUp = () => { renderTypeSprint(); }; }
  } else {
    stopTimer();
    $("#timerBadge").textContent = "‚è± Off";
  }

  if (App.settings.timerOn && s.timeLeft <= 0) {
    showAfter("Time!", `Correct: ${s.typeSprint.correct} ‚Ä¢ Wrong: ${s.typeSprint.wrong} ‚Ä¢ Score: ${s.score}`, "good");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="typeAgain">Play again</button>
      <button class="btn" id="typeExit">Exit</button>
    </div>`;
    $("#typeAgain").addEventListener("click", () => startMode("type"));
    $("#typeExit").addEventListener("click", endSession);
    return;
  }

  // Ask next typed question using standard picker
  const q = pickNextQuestion();
  if (!q) { endSession(); return; }
  s.used.add(q.id);

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-pink" style="font-weight:900;">TYPE‚ÄëIT SPRINT</div>
      <div class="tag">‚úÖ ${s.typeSprint.correct} / ‚ùå ${s.typeSprint.wrong}</div>
    </div>
    <div style="margin-top:10px;">${formatPrompt(q)}</div>
  `;

  $("#gameControls").innerHTML = `
    <div class="row">
      <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
      <button class="btn primary" id="submitBtn">Submit</button>
      <button class="btn" id="skipBtn">Skip</button>
    </div>
    <div class="mini" style="margin-top:10px;">60 seconds. Keep moving.</div>
  `;
  const input = $("#answerInput"); input.focus();

  const submit = () => {
    const v = isCorrect(q, input.value);
    if (v === null) { showSelfCheck(q, input.value); return; }
    recordAttempt(q, v);
    if (v) {
      s.typeSprint.correct += 1;
      const gained = 8;
      s.score += gained;
      if (App.settings.play==="teams") App.teams[s.teamIndex].score += gained;
      beepSoft();
      toast("‚úÖ", `+${gained}`);
    } else {
      s.typeSprint.wrong += 1;
      toast("‚ùå", `Ans: ${bestAnswerText(q)}`);
    }
    if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
    renderTypeSprint();
  };
  $("#submitBtn").addEventListener("click", submit);
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); });
  $("#skipBtn").addEventListener("click", () => { recordAttempt(q,false); s.typeSprint.wrong += 1; toast("Skipped", `Ans: ${bestAnswerText(q)}`); renderTypeSprint(); });

  renderScoreStrip();
}

/** =======================
 * Mode: Survival (3 lives)
 * ======================= */
function renderSurvival() {
  const s = App.session;
  if (!s.survival) s.survival = { lives: 3 };

  if (s.survival.lives <= 0) {
    App.bestSurvival = Math.max(App.bestSurvival||0, s.score);
    persist();
    showAfter("GAME OVER", `Score: ${s.score} ‚Ä¢ Best: ${App.bestSurvival||s.score}`, "bad");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="survAgain">Try again</button>
      <button class="btn" id="survExit">Exit</button>
    </div>`;
    $("#survAgain").addEventListener("click", () => startMode("survival"));
    $("#survExit").addEventListener("click", endSession);
    return;
  }

  if (!s.question) {
    s.question = pickNextQuestion();
    if (!s.question) { endSession(); return; }
    s.used.add(s.question.id);
    if (App.settings.timerOn) { s.timeLeft = App.settings.timerSeconds; startTimer(); }
    else { stopTimer(); $("#timerBadge").textContent = "‚è± Off"; }
  }
  const q = s.question;

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">SURVIVAL</div>
      <div class="tag">‚ù§Ô∏è ${"‚ô•".repeat(s.survival.lives)}${"¬∑".repeat(Math.max(0, 3-s.survival.lives))}</div>
    </div>
    <div style="margin-top:10px;">${formatPrompt(q)}</div>
  `;

  // Use default typing UI but custom submit handler
  $("#gameControls").innerHTML = `
    <div class="row">
      <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
      <button class="btn primary" id="submitBtn">Submit</button>
      <button class="btn" id="skipBtn">Skip</button>
    </div>
    <div class="mini" style="margin-top:10px;">Wrong answers cost a life.</div>
  `;
  const input = $("#answerInput"); input.focus();

  const submit = () => {
    const v = isCorrect(q, input.value);
    if (v === null) { showSelfCheck(q, input.value); return; }
    stopTimer();
    recordAttempt(q, v);
    if (v) {
      const gained = pointsFor(q, true);
      s.score += gained;
      if (App.settings.play==="teams") App.teams[s.teamIndex].score += gained;
      beepSoft();
      showAfter("‚úÖ", `+${gained} ‚Ä¢ ${bestAnswerText(q)}`, "good");
    } else {
      s.survival.lives -= 1;
      showAfter("‚ùå", `Life lost ‚Ä¢ Answer: ${bestAnswerText(q)}`, "bad");
    }
    if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
    s.question = null;
    setTimeout(renderSurvival, App.settings.reduceMotion ? 150 : 420);
  };

  $("#submitBtn").addEventListener("click", submit);
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); });
  $("#skipBtn").addEventListener("click", () => { stopTimer(); recordAttempt(q,false); s.survival.lives -= 1; showAfter("Skipped", `Life lost ‚Ä¢ ${bestAnswerText(q)}`, "bad"); s.question=null; setTimeout(renderSurvival, 250); });

  renderScoreStrip();
}

/** =======================
 * Mode: Boss Battle
 * ======================= */
/** ===== Boss Battle FX helpers (shake + flash + lunge + floating damage) ===== */
function bossFxOnce(el, cls, ms=360){
  if (!el) return;
  el.classList.remove(cls); // restart animation
  void el.offsetWidth;      // force reflow
  el.classList.add(cls);
  setTimeout(()=>el.classList.remove(cls), ms);
}

function bossShake(intensity=10){
  if (App.settings.reduceMotion) return;
  const card = document.querySelector("#view-game .card");
  if (!card) return;
  card.style.setProperty("--shake", `${Math.max(6, Math.min(18, intensity))}px`);
  bossFxOnce(card, "bossShake", 380);
}

function bossFlash(kind){ // "good" | "bad"
  const stage = document.getElementById("bossStage");
  if (!stage || App.settings.reduceMotion) return;
  const cls = kind === "bad" ? "flash-bad" : "flash-good";
  stage.classList.remove("flash-bad","flash-good");
  void stage.offsetWidth;
  stage.classList.add(cls);
  setTimeout(()=>stage.classList.remove(cls), 300);
}

function bossLunge(attacker){ // "hero" | "boss"
  if (App.settings.reduceMotion) return;
  const el = document.getElementById(attacker === "boss" ? "bossFighter" : "heroFighter");
  bossFxOnce(el, "atk", 360);
}

function bossHit(target){ // "hero" | "boss"
  if (App.settings.reduceMotion) return;
  const el = document.getElementById(target === "boss" ? "bossFighter" : "heroFighter");
  bossFxOnce(el, "hit", 340);
}

function bossFloatDamage(target, amount, kind){ // target "hero"|"boss", kind "good"|"bad"
  const stage = document.getElementById("bossStage");
  const fighter = document.getElementById(target === "boss" ? "bossFighter" : "heroFighter");
  if (!stage || !fighter) return;

  const sRect = stage.getBoundingClientRect();
  const fRect = fighter.getBoundingClientRect();

  const el = document.createElement("div");
  el.className = `floatDmg ${kind}` + (App.settings.reduceMotion ? " nomotion" : "");
  el.textContent = `-${amount}`;

  // position near fighter center
  const x = (fRect.left + fRect.width/2) - sRect.left;
  const y = (fRect.top + 10) - sRect.top;

  el.style.left = `${Math.round(x)}px`;
  el.style.top  = `${Math.round(y)}px`;

  stage.appendChild(el);

  setTimeout(()=>{ try{ el.remove(); }catch{} }, App.settings.reduceMotion ? 600 : 900);
}

function bossUpdateBars(playerHP, bossHP){
  const bossFill = document.getElementById("bossHPFill");
  const heroFill = document.getElementById("heroHPFill");
  if (bossFill) bossFill.style.width = `${clamp(bossHP,0,120)/120*100}%`;
  if (heroFill) heroFill.style.width = `${clamp(playerHP,0,100)}%`;
}
    function renderBossBattle() {
  const s = App.session;
  if (!s.boss) s.boss = { playerHP: 100, bossHP: 120 };

  if (s.boss.playerHP <= 0) {
    showAfter("DEFEATED", `Final score: ${s.score}`, "bad");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="bossAgain">Rematch</button>
      <button class="btn" id="bossExit">Exit</button>
    </div>`;
    $("#bossAgain").addEventListener("click", () => startMode("boss"));
    $("#bossExit").addEventListener("click", endSession);
    return;
  }
  if (s.boss.bossHP <= 0) {
    showAfter("VICTORY", `You defeated the boss! Score: ${s.score}`, "good");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="bossAgain">Fight again</button>
      <button class="btn" id="bossExit">Exit</button>
    </div>`;
    $("#bossAgain").addEventListener("click", () => startMode("boss"));
    $("#bossExit").addEventListener("click", endSession);
    return;
  }

  // pick next question each round
  const q = pickNextQuestion();
  if (!q) { endSession(); return; }
  s.used.add(q.id);

    // boss HUD (with arena strip)
  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="font-tech neon-text-pink" style="font-weight:900;">BOSS BATTLE</div>
      <div class="tag">HP: You ${s.boss.playerHP} ‚Ä¢ Boss ${s.boss.bossHP}</div>
    </div>

    <div class="bossStrip">
      <div class="bossMeta">
        <div class="mini">Boss</div>
        <div class="bar"><div id="bossHPFill" style="width:${clamp(s.boss.bossHP,0,120)/120*100}%;"></div></div>
      </div>

      <div class="bossStage" id="bossStage" aria-hidden="true">
        <div class="fighter hero" id="heroFighter">üõ°Ô∏è</div>
        <div class="fighter boss" id="bossFighter">üëπ</div>
        <div class="bossFlash"></div>
      </div>

      <div class="bossMeta right">
        <div class="mini">You</div>
        <div class="bar"><div id="heroHPFill" style="width:${clamp(s.boss.playerHP,0,100)}%; filter:hue-rotate(130deg);"></div></div>
      </div>
    </div>

    <div style="margin-top:12px; font-weight:900;">${formatPrompt(q)}</div>
  `;

  const pool = s.opts.customPool || s.pool;
  const mc = buildMCOptionsFor(q, pool, 4);
  if (App.settings.timerOn) { s.timeLeft = App.settings.timerSeconds; startTimer(); }
  else { stopTimer(); $("#timerBadge").textContent = "‚è± Off"; }
if (mc) {
  $("#gameControls").innerHTML = `
    <div class="choices">
      ${mc.options.map((o,i)=>`<button class="choice" data-bosschoice="${i}">${escapeHtml(o)}</button>`).join("")}
    </div>
    <div class="mini" style="margin-top:10px;">Correct deals damage. Wrong takes damage.</div>
  `;

  const resolve = (correct) => {
    stopTimer();

    // prevent double-clicks
    $all("[data-bosschoice]").forEach(b => b.disabled = true);

    recordAttempt(q, correct);

    if (correct) {
      const dmg = 18 + Math.floor(Math.random()*10);
      s.boss.bossHP -= dmg;

      const gained = 10;
      s.score += gained;
      if (App.settings.play==="teams") App.teams[s.teamIndex].score += gained;

      // FX
      bossLunge("hero");
      bossHit("boss");
      bossFlash("good");
      bossFloatDamage("boss", dmg, "good");
      bossUpdateBars(s.boss.playerHP, s.boss.bossHP);

      beepSoft();
      showAfter("‚öîÔ∏è HIT!", `-${dmg} boss HP ‚Ä¢ +${gained} pts`, "good");
    } else {
      const dmg = 22;
      s.boss.playerHP -= dmg;

      // FX (wrong answer = weight)
      bossLunge("boss");
      bossHit("hero");
      bossFlash("bad");
      bossShake(dmg);
      bossFloatDamage("hero", dmg, "bad");
      bossUpdateBars(s.boss.playerHP, s.boss.bossHP);

      showAfter("üí• OUCH", `-${dmg} your HP ‚Ä¢ Answer: ${mc.accepted}`, "bad");
    }

    if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;

    // give animations time to land
    setTimeout(renderBossBattle, App.settings.reduceMotion ? 150 : 780);
  };

  // ‚úÖ REQUIRED: click handlers
  $all("[data-bosschoice]").forEach(btn => btn.addEventListener("click", () => {
    const pick = mc.options[Number(btn.dataset.bosschoice)];
    resolve(normalize(pick) === normalize(mc.accepted));
  }));

  // time up: count as wrong
  s.onTimeUp = () => resolve(false);

} else {
  // typed fallback
  $("#gameControls").innerHTML = `
    <div class="row">
      <input id="answerInput" class="input" placeholder="Type your answer‚Ä¶" autocomplete="off" />
      <button class="btn primary" id="submitBtn">Submit</button>
    </div>
  `;
  const input = $("#answerInput"); input.focus();

  const resolve = (v) => {
  stopTimer();

  // prevent double submits
  $("#submitBtn").disabled = true;
  input.disabled = true;

  recordAttempt(q, v);

  if (v) {
    const dmg = 18 + Math.floor(Math.random()*10);
    s.boss.bossHP -= dmg;

    const gained = 10;
    s.score += gained;
    if (App.settings.play === "teams") App.teams[s.teamIndex].score += gained;

    bossLunge("hero");
    bossHit("boss");
    bossFlash("good");
    bossFloatDamage("boss", dmg, "good");
    bossUpdateBars(s.boss.playerHP, s.boss.bossHP);

    beepSoft();
    showAfter("‚öîÔ∏è HIT!", `-${dmg} boss HP ‚Ä¢ +${gained} pts`, "good");
  } else {
    const dmg = 22;
    s.boss.playerHP -= dmg;

    bossLunge("boss");
    bossHit("hero");
    bossFlash("bad");
    bossShake(dmg);
    bossFloatDamage("hero", dmg, "bad");
    bossUpdateBars(s.boss.playerHP, s.boss.bossHP);

    showAfter("üí• OUCH", `-${dmg} your HP ‚Ä¢ Answer: ${bestAnswerText(q)}`, "bad");
  }

  if (App.settings.play === "teams") s.teamIndex = (s.teamIndex + 1) % App.teams.length;

  setTimeout(renderBossBattle, App.settings.reduceMotion ? 150 : 780);
};

  $("#submitBtn").addEventListener("click", () => {
    const v = isCorrect(q, input.value);
    if (v === null) { showSelfCheck(q, input.value); return; }
    resolve(v);
  });
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("#submitBtn").click(); });

  s.onTimeUp = () => resolve(false);
}
  
  renderScoreStrip();
}

/** =======================
 * Mode: Conquest (3x3) with working timers
 * ======================= */
function initConquestGrid() {
  // 0=neutral, 1=player, 2=enemy
  const g = Array(9).fill(0);
  g[4]=1;
  g[0]=2; g[8]=2;
  return g;
}
function cAdj(a,b){
  const r1=Math.floor(a/3), c1=a%3, r2=Math.floor(b/3), c2=b%3;
  return Math.abs(r1-r2)+Math.abs(c1-c2)===1;
}
function renderConquest() {
  const s = App.session;
  const v = s.conquest || (s.conquest={ grid:initConquestGrid(), turn:1, selected:null, msg:"Attack an adjacent tile."});
  const grid = v.grid;

  const playerCount = grid.filter(x=>x===1).length;
  const enemyCount = grid.filter(x=>x===2).length;

  if (playerCount===0) {
    showAfter("DEFEAT", "Your empire has fallen.", "bad");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="cqAgain">Try again</button>
      <button class="btn" id="cqExit">Exit</button>
    </div>`;
    $("#cqAgain").addEventListener("click", ()=>startMode("conquest"));
    $("#cqExit").addEventListener("click", endSession);
    return;
  }
  if (enemyCount===0) {
    showAfter("VICTORY", "The world is yours!", "good");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="cqAgain">Play again</button>
      <button class="btn" id="cqExit">Exit</button>
    </div>`;
    $("#cqAgain").addEventListener("click", ()=>startMode("conquest"));
    $("#cqExit").addEventListener("click", endSession);
    return;
  }

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">REALM CONQUEST</div>
      <div class="tag">Turn ${v.turn} ‚Ä¢ You ${playerCount} vs Enemy ${enemyCount}</div>
    </div>
    <div class="notice" style="margin-top:10px;">${escapeHtml(v.msg)}</div>
  `;

  $("#gameControls").innerHTML = `
    <div class="cGrid">
      ${grid.map((cell,idx)=>{
        const cls = cell===1?"cCell you":(cell===2?"cCell them":"cCell");
        const label = cell===1?"üè∞":(cell===2?"‚öîÔ∏è":(idx+1));
        return `<button class="${cls}" data-ctile="${idx}">${label}</button>`;
      }).join("")}
    </div>
    <div class="row" style="margin-top:12px; justify-content:space-between;">
      <div class="mini">Attack adjacent tiles to expand.</div>
      <button class="btn" id="cqReset">Reset</button>
    </div>
  `;
  $("#cqReset").addEventListener("click", ()=>{ s.conquest = { grid:initConquestGrid(), turn:1, selected:null, msg:"Attack an adjacent tile."}; renderConquest(); });

  const canAttack = (idx) => grid[idx]!==1 && grid.some((val,i)=>val===1 && cAdj(i,idx));
  $all("[data-ctile]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.ctile);
      if (!canAttack(idx)) { v.msg = "Too far. Attack adjacent tiles only."; renderConquest(); return; }
      v.selected = idx;
      v.msg = "Answer to conquer!";
      // ask question in overlay with timer
      const q = pickNextQuestion();
      if (!q) { endSession(); return; }
      s.used.add(q.id);

      overlayAskQuestion(q, "Attack!", {
        seconds: App.settings.timerSeconds,
        closeIsWrong: true,
        onResult: (correct, ans, why) => {
          if (!App.session || App.session.modeId!=="conquest") return;
          if (correct) {
            grid[idx] = 1;
            s.score += 20;
            if (App.settings.play==="teams") App.teams[s.teamIndex].score += 20;
            beepSoft();
            v.msg = "Victory! Territory claimed. (+20)";
          } else {
            v.msg = `Attack failed (${why}).`;
          }
          v.selected = null;
          // enemy turn after short delay
          setTimeout(()=>enemyTurnConquest(), 450);
        }
      });
    });
  });

  renderScoreStrip();
}

function enemyTurnConquest() {
  const s = App.session;
  if (!s || s.modeId!=="conquest") return;
  const v = s.conquest;
  const grid = v.grid;

  // choose a tile adjacent to enemy to flip (prefers neutral)
  const enemies = grid.map((v,i)=>v===2?i:-1).filter(i=>i!==-1);
  let target = -1;
  for (const eIdx of shuffle(enemies)) {
    for (let i=0;i<9;i++){
      if (!cAdj(eIdx,i)) continue;
      if (grid[i]===0) { target=i; break; }
      if (grid[i]===1 && Math.random() < 0.25) { target=i; break; }
    }
    if (target!==-1) break;
  }
  if (target!==-1) {
    grid[target]=2;
    v.msg = `Enemy captured sector ${target+1}!`;
  } else {
    v.msg = "Enemy holds position.";
  }
  v.turn += 1;
  if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
  renderConquest();
}

/** =======================
 * Mode: Jeopardy Grid (with working timers)
 * ======================= */
function initJeopardyBoard() {
  const units = selectedUnits();
  const cols = Math.min(5, Math.max(3, units.length));
  const pickedUnits = units.slice(0, cols);
  while (pickedUnits.length < cols) pickedUnits.push(units[pickedUnits.length % units.length] || "unit1");

  const values = [100,200,300,400,500];
  const board = [];
  const pool = currentPool();
  for (let c=0;c<cols;c++){
    const u = pickedUnits[c];
    const qs = shuffle(pool.filter(q=>q.unit===u));
    for (let r=0;r<5;r++){
      const q = qs[r] || shuffle(pool)[0];
      board.push({ key:`${c}-${r}`, col:c, row:r, unit:u, value: values[r], qid:q?.id || null, done:false });
    }
  }
  return { cols, units: pickedUnits, tiles: board, active: null, msg:"Pick a tile." };
}

function renderJeopardy() {
  const s = App.session;
  const j = s.jeopardy || (s.jeopardy = initJeopardyBoard());
  const pool = currentPool();

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">JEOPARDY GRID</div>
      <div class="tag">${escapeHtml(j.msg || "Pick a tile")}</div>
    </div>
    <div class="mini" style="margin-top:8px;">Teams: rotate after each tile. Timer applies inside the question.</div>
  `;

  const colsClass = j.cols === 5 ? "cols-5" : "cols-4";
  const header = j.units.map(u => `<div class="jCat font-tech">${escapeHtml((UNIT_META[u]||u).replace("Unit","U"))}</div>`).join("");
  // Tiles by rows
  const rows = [0,1,2,3,4].map(r=>{
    return Array.from({length:j.cols}, (_,c)=>{
      const t = j.tiles.find(x=>x.col===c && x.row===r);
      return `<button class="jTile ${t.done?'done':''}" data-jtile="${t.key}" ${t.done?'disabled':''}>${t.done?'‚Äî':("$"+t.value)}</button>`;
    }).join("");
  }).join("");

  $("#gameControls").innerHTML = `
    <div class="jBoard ${colsClass}">
      ${header}
      ${rows}
    </div>
    <div class="row" style="margin-top:12px; justify-content:space-between;">
      <button class="btn" id="jNew">New board</button>
      <button class="btn primary" id="jEnd">End session</button>
    </div>
  `;
  $("#jNew").addEventListener("click", ()=>{ s.jeopardy = initJeopardyBoard(); renderJeopardy(); });
  $("#jEnd").addEventListener("click", endSession);

  $all("[data-jtile]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.jtile;
      const t = j.tiles.find(x=>x.key===key);
      if (!t || t.done) return;

      // pick question: use tile qid if available else choose unit question
      const unitQs = pool.filter(q=>q.unit===t.unit);
      let q = unitQs.find(x=>x.id===t.qid) || unitQs.find(x=>!s.used.has(x.id)) || unitQs[0] || pool[0];
      if (!q) return;
      s.used.add(q.id);

      j.msg = `${teamLabel(s.teamIndex)} for $${t.value}`;
      overlayAskQuestion(q, `Jeopardy ‚Ä¢ $${t.value}`, {
        seconds: App.settings.timerSeconds,
        closeIsWrong: true,
        onResult: (correct, ans, why) => {
          if (!App.session || App.session.modeId!=="jeopardy") return;
          t.done = true;
          if (correct) {
            s.score += t.value;
            if (App.settings.play==="teams") App.teams[s.teamIndex].score += t.value;
            beepSoft();
            j.msg = `‚úÖ +$${t.value}`;
          } else {
            // Jeopardy traditionally deducts; keep it optional via setting later ‚Äî for now deduct half value
            const loss = Math.floor(t.value/2);
            s.score -= loss;
            if (App.settings.play==="teams") App.teams[s.teamIndex].score -= loss;
            j.msg = `‚ùå -$${loss} (${why}) ‚Ä¢ Ans: ${ans}`;
          }
          if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;

          // end if all done
          if (j.tiles.every(x=>x.done)) {
            showAfter("Board cleared!", `Final score: ${s.score}`, "good");
            $("#afterControls").classList.remove("hidden");
            $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
              <button class="btn primary" id="jAgain">New board</button>
              <button class="btn" id="jExit">Exit</button>
            </div>`;
            $("#jAgain").addEventListener("click", ()=>{ s.jeopardy = initJeopardyBoard(); renderJeopardy(); });
            $("#jExit").addEventListener("click", endSession);
            renderScoreStrip();
            return;
          }
          renderJeopardy();
        }
      });
    });
  });

  renderScoreStrip();
}

/** =======================
 * Mode: Wager Wheel
 * ======================= */
function renderWagerWheel() {
  const s = App.session;
  if (!s.wager) s.wager = { bank: 0, lastWager: 10 };
  const w = s.wager;

  // pick question each round
  const q = pickNextQuestion();
  if (!q) { endSession(); return; }
  s.used.add(q.id);

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-pink" style="font-weight:900;">WAGER WHEEL</div>
      <div class="tag">Bank: ${w.bank}</div>
    </div>
    <div style="margin-top:10px;">${formatPrompt(q)}</div>
  `;

  $("#gameControls").innerHTML = `
    <div class="notice">
      Choose your wager, then answer. Correct adds, wrong subtracts.
    </div>
    <div class="row" style="gap:10px; margin-top:12px; flex-wrap:wrap;">
      ${[5,10,20,30,50].map(v=>`<button class="btn ${v===w.lastWager?'primary':''}" data-wager="${v}">${v}</button>`).join("")}
    </div>
    <div id="wagerArea" style="margin-top:12px;"></div>
  `;

  let wager = w.lastWager;
  const setArea = () => {
    $("#wagerArea").innerHTML = `
      <div class="row" style="gap:10px; align-items:center;">
        <span class="badge">Wager: ${wager}</span>
        <button class="btn primary" id="wagerStart">Answer</button>
      </div>
    `;
    $("#wagerStart").addEventListener("click", () => {
      // ask in overlay with timer
      overlayAskQuestion(q, `Wager: ${wager}`, {
        seconds: App.settings.timerSeconds,
        closeIsWrong: true,
        onResult: (correct, ans, why) => {
          if (!App.session || App.session.modeId!=="wager") return;
          if (correct) {
            s.score += wager; w.bank += wager;
            if (App.settings.play==="teams") App.teams[s.teamIndex].score += wager;
            beepSoft();
            showAfter("‚úÖ", `+${wager} ‚Ä¢ ${ans}`, "good");
          } else {
            s.score -= wager; w.bank -= wager;
            if (App.settings.play==="teams") App.teams[s.teamIndex].score -= wager;
            showAfter("‚ùå", `-${wager} (${why}) ‚Ä¢ Ans: ${ans}`, "bad");
          }
          if (App.settings.play==="teams") s.teamIndex = (s.teamIndex+1)%App.teams.length;
          w.lastWager = wager;
          setTimeout(renderWagerWheel, App.settings.reduceMotion ? 150 : 520);
        }
      });
    });
  };

  $all("[data-wager]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      wager = Number(btn.dataset.wager);
      w.lastWager = wager;
      $all("[data-wager]").forEach(b=>b.classList.toggle("primary", Number(b.dataset.wager)===wager));
      setArea();
    });
  });
  setArea();

  renderScoreStrip();
}

/** =======================
 * Mode: Chrono Stream (uses a small built-in chronology set)
 * ======================= */
const CHRONO_EVENTS_V6 = [
  { event:"Construction of the Great Pyramid", year:-2560 },
  { event:"Code of Hammurabi", year:-1754 },
  { event:"Founding of Rome", year:-753 },
  { event:"Birth of Confucius", year:-551 },
  { event:"Julius Caesar assassinated", year:-44 },
  { event:"Fall of Western Roman Empire", year:476 },
  { event:"Birth of Muhammad", year:570 },
  { event:"Charlemagne crowned Emperor", year:800 },
  { event:"Magna Carta signed", year:1215 },
  { event:"Fall of Constantinople", year:1453 },
  { event:"Columbus reaches the Americas", year:1492 },
  { event:"Martin Luther‚Äôs 95 Theses", year:1517 },
  { event:"French Revolution begins", year:1789 },
  { event:"Start of World War I", year:1914 },
  { event:"Start of World War II", year:1939 },
  { event:"Fall of Berlin Wall", year:1989 }
];

function initChronoStream() {
  const shuffled = shuffle(CHRONO_EVENTS_V6);
  return { current: shuffled[0], next: shuffled[1], streak: 0, state:"play", feedback:null };
}

function renderChronoStream() {
  const s = App.session;
  if (!s.chrono) s.chrono = initChronoStream();
  const c = s.chrono;

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">TIME STREAM</div>
      <div class="tag">Streak: ${c.streak}</div>
    </div>
    <div class="mini" style="margin-top:8px;">Before or After? Keep the streak alive.</div>
  `;

  if (c.state === "over") {
    showAfter("Timeline broken", `Final streak: ${c.streak}`, "bad");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="chAgain">Repair time</button>
      <button class="btn" id="chExit">Exit</button>
    </div>`;
    $("#chAgain").addEventListener("click", ()=>{ s.chrono = initChronoStream(); renderChronoStream(); });
    $("#chExit").addEventListener("click", endSession);
    renderScoreStrip();
    return;
  }

  const yearText = (y)=> `${Math.abs(y)} ${y<0?"BC":"AD"}`;
  $("#gameControls").innerHTML = `
    <div class="row" style="gap:14px; align-items:stretch; flex-wrap:wrap;">
      <div class="card neon-box" style="flex:1; min-width:240px;">
        <div class="mini">Known</div>
        <div style="font-weight:900; font-size:18px; margin-top:6px;">${escapeHtml(c.current.event)}</div>
        <div class="tag" style="margin-top:10px;">${yearText(c.current.year)}</div>
      </div>
      <div class="card" style="flex:1; min-width:240px;">
        <div class="mini">Mystery</div>
        <div style="font-weight:900; font-size:18px; margin-top:6px;">${escapeHtml(c.next.event)}</div>
        <div class="tag" style="margin-top:10px;">????</div>
      </div>
    </div>
    <div class="row" style="justify-content:center; gap:10px; margin-top:14px;">
      <button class="btn primary" id="chronoBefore">Happened BEFORE</button>
      <button class="btn" id="chronoAfter">Happened AFTER</button>
    </div>
  `;
  const guess = (g) => {
    const correct = (g==="before" && c.next.year < c.current.year) || (g==="after" && c.next.year > c.current.year);
    if (correct) {
      c.streak += 1;
      s.score += 10;
      beepSoft();
      c.current = c.next;
      // pick a new next different from current
      let n;
      do { n = CHRONO_EVENTS_V6[Math.floor(Math.random()*CHRONO_EVENTS_V6.length)]; } while (n.event===c.current.event);
      c.next = n;
      toast("‚úÖ", "Correct!");
      renderChronoStream();
    } else {
      c.state="over";
      toast("‚ùå", `Answer was ${yearText(c.next.year)}`);
      renderChronoStream();
    }
  };
  $("#chronoBefore").addEventListener("click", ()=>guess("before"));
  $("#chronoAfter").addEventListener("click", ()=>guess("after"));

  renderScoreStrip();
}

/** =======================
 * Mode: Memory Flip
 * ======================= */
function renderMemoryFlip() {
  const s = App.session;
  const pool = currentPool().filter(q => hasAutoAnswers(q) && !Array.isArray(q.acceptedAnswers?.[0]));
  if (!pool.length) { toast("No cards", "Not enough auto-graded questions in this unit selection."); endSession(); return; }

  if (!s.memory) {
    const picks = sample(pool, 6);
    const cards = shuffle([
      ...picks.map(q=>({ key:q.id+"-p", kind:"prompt", text:q.prompt, match:q.id })),
      ...picks.map(q=>({ key:q.id+"-a", kind:"answer", text:q.acceptedAnswers[0], match:q.id }))
    ]).map(c=>({ ...c, faceUp:false, done:false }));
    s.memory = { cards, flipped: [], moves: 0, found: 0 };
  }
  const m = s.memory;

  if (m.found >= 6) {
    showAfter("CLEARED!", `Moves: ${m.moves} ‚Ä¢ Score: ${s.score}`, "good");
    $("#afterControls").classList.remove("hidden");
    $("#afterControls").innerHTML = `<div class="row" style="gap:10px;">
      <button class="btn primary" id="memAgain">New set</button>
      <button class="btn" id="memExit">Exit</button>
    </div>`;
    $("#memAgain").addEventListener("click", ()=>{ s.memory=null; renderMemoryFlip(); });
    $("#memExit").addEventListener("click", endSession);
    return;
  }

  $("#prompt").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div class="font-tech neon-text-blue" style="font-weight:900;">MEMORY FLIP</div>
      <div class="tag">Moves: ${m.moves} ‚Ä¢ Found: ${m.found}/6</div>
    </div>
    <div class="mini" style="margin-top:8px;">Match prompt ‚Üî answer pairs.</div>
  `;

  const cols = 4;
  $("#gameControls").innerHTML = `
    <div class="grid" style="display:grid; grid-template-columns: repeat(${cols}, minmax(0,1fr)); gap:10px;">
      ${m.cards.map((c,idx)=>{
        const face = (c.faceUp || c.done) ? (c.kind==="prompt" ? escapeHtml(shorten(c.text, 90)) : `<strong>${escapeHtml(c.text)}</strong>`) : "‚òÖ";
        const cls = `card ${c.done?'good':''}`;
        return `<button class="${cls}" style="min-height:92px; text-align:left;" data-mem="${idx}" ${c.done?'disabled':''}>
          <div class="mini">${c.faceUp||c.done ? (c.kind==="prompt"?"Prompt":"Answer") : "Flip"}</div>
          <div style="margin-top:6px; font-weight:900;">${face}</div>
        </button>`;
      }).join("")}
    </div>
    <div class="row" style="margin-top:12px; justify-content:space-between;">
      <button class="btn" id="memReset">New set</button>
      <button class="btn" id="memExit2">Exit</button>
    </div>
  `;
  $("#memReset").addEventListener("click", ()=>{ s.memory=null; renderMemoryFlip(); });
  $("#memExit2").addEventListener("click", endSession);

  function flip(idx){
    const c = m.cards[idx];
    if (!c || c.done || c.faceUp) return;
    if (m.flipped.length >= 2) return;
    c.faceUp = true;
    m.flipped.push(idx);
    renderMemoryFlip();

    if (m.flipped.length === 2) {
      m.moves += 1;
      const [a,b] = m.flipped.map(i=>m.cards[i]);
      const match = a.match === b.match && a.kind !== b.kind;
      setTimeout(()=>{
        if (match) {
          a.done = true; b.done = true;
          m.found += 1;
          s.score += 15;
          beepSoft();
          toast("‚úÖ Match", "+15");
        } else {
          a.faceUp = false; b.faceUp = false;
          toast("‚ùå", "No match");
        }
        m.flipped = [];
        renderMemoryFlip();
      }, App.settings.reduceMotion ? 150 : 520);
    }
  }

  $all("[data-mem]").forEach(btn => btn.addEventListener("click", ()=>flip(Number(btn.dataset.mem))));

  renderScoreStrip();
}

function shorten(t, n){ t = (t||"").trim(); return t.length>n ? t.slice(0,n-1)+"‚Ä¶" : t; }


function renderInitial() {
  ensureScanlines();
  ensureStars();
  syncHomeControls();
  syncSettingsUI();
  renderModeGrid();
  renderAll();
}
renderInitial();
</script>
</body>
</html>